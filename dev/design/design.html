<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Design &amp; concepts</title>
<style>
/*! Copyright (C) 2019, TomTom (http://tomtom.com).
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* Extension of the AsciiDoctor CSS for AsciiDoxy.
 * Adding:
 * - Floating multipage navigation.
 */
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

/* Multipage navigation */
div#navigation {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}
div#navigation table {
    margin-bottom: 0;
}
@media screen and (min-width: 768px) {
    body.toc2 div#navigation {
        left: 15em;
    }
    body.toc2.toc-right div#navigation {
        right: 15em;
    }
}
@media screen and (min-width: 1280px) {
    body.toc2 div#navigation {
        left: 20em;
    }
    body.toc2.toc-right div#navigation {
        right: 20em;
    }
}

</style>
</head>
<body class="article">
<div id="header">
<h1>Design &amp; concepts</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The rs-servcer is divided into two main elements :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the rs-server frontend</p>
</li>
<li>
<p>the rs-server backend</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The rs-server frontend is a facade for users that verify the user privileges before accessing to the services provided by the rs-server backend.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rs_server_frontend">rs-server frontend</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO To Be Defined
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rs_server_backend">rs-server backend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The rs-server backend is divided in several services.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO insert a table of the service with short description and the list of functionalities
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each service provides several functionalities as https endpoints.
All services are independent of others.
Each service is provided as an independent Docker image.
Each service can be started in laptop or cluster mode. (see later for more details)
Each service can handle multiple requests in parallel in cluster mode.
Services are stateless, so they can easily be scaled
and the activity be divided into the multiple instances.</p>
</div>
<div class="paragraph">
<p>All services shares some common structures and mechanisms.
These common elements are provided by the rs-server-common package.</p>
</div>
<div class="sect2">
<h3 id="_structure">Structure</h3>
<div class="paragraph">
<p>A rs-server service is divided in 3 layers :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the api layer provides the http endpoints to call the service</p>
</li>
<li>
<p>the event layer provides the kafka interface (read / write)</p>
</li>
<li>
<p>the library layer provides the business logic</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_sources_organisation">Sources organisation</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO insert the servie tree structure here
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each service has its own folder named with the service name.
This folder is a python project.
It contains the sources, tests, configuration,&#8230;&#8203; for this service.
It also contains a Dockerfile describing the service output image.
The sources of each layer is separated in a specific package.</p>
</div>
<div class="paragraph">
<p>The shared elements are provided by the rs-server-common package.
It is handled as a python project as if it is a rs-server service.</p>
</div>
</div>
<div class="sect3">
<h4 id="_layers">Layers</h4>
<div class="paragraph">
<p>In each service, the api is separated from the library.
The api is responsible for providing the given http endpoints.
The library is composed of several modules providing the business logic.</p>
</div>
<div class="paragraph">
<p>The api doesn&#8217;t provide functionalities itself.
It uses the library to provide the functionality.</p>
</div>
<div class="sect4">
<h5 id="_the_api">The API</h5>
<div class="paragraph">
<p>The API is responsible for providing a REST endpoint
to access the core library functionalities.
It does no functional processes.</p>
</div>
<div class="paragraph">
<p>It checks the request parameters
Then, it delegates the processing in background.
Finally, it builds an adequate response.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO insert the activity diagram api/activity.mmd
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The process delegation differs depending on the starting mode.</p>
</div>
<div class="sect5">
<h6 id="_structure_2">Structure</h6>
<div class="paragraph">
<p>For all services, the api layer is a python package named 'api'.
This package contains a module for each endpoint.
This package uses the common api package for common mechanisms.</p>
</div>
<div class="paragraph">
<p>There is two implementation for each endpoint :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a local implementation that delegates the process to the library</p>
</li>
<li>
<p>a cluster implement that delegates the process to a kafka event bus</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_shared_elements">Shared elements</h6>
<div class="paragraph">
<p>All service api layers share common mechanisms.
These mechanisms are provided in a common api module.</p>
</div>
</div>
<div class="sect5">
<h6 id="_framework_used">Framework used</h6>
<div class="paragraph">
<p>This layer is implemented using FastAPI.</p>
</div>
</div>
<div class="sect5">
<h6 id="_deploy_mode">Deploy mode</h6>
<div class="paragraph">
<p>The deploy mode modifies the endpoint initialized at the start of the application.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Deploy mode</th>
<th class="tableblock halign-left valign-top">Endpoints initialized</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">laptop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cadip laptop endpoints</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cluster-api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cadip cluster endpoints</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cluster-service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO insert the api/class.mmd
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous class diagram how these modes are handled in the design.
Each endpoint has two implementations : one for laptop and one for cadip-api.</p>
</div>
<div class="paragraph">
<p>At the start of the application, the expected endpoints are routed.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_the_core_library">The core library</h5>
<div class="paragraph">
<p>The core library is responsible for providing the rs-server functionalities.
It is independent of the API layer.
The business logic is kept independent of technical stuff like transfer protocol.
It is divided on multiple functional modules like data_retrieval.</p>
</div>
<div class="paragraph">
<p>There is common mechanisms that are shared.
The shared elements are provided by the library package of the common python project.</p>
</div>
<div class="sect5">
<h6 id="_modules">Modules</h6>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO Brief introduction with the list of main modules
</td>
</tr>
</table>
</div>
<div class="sect6">
<h7 id="_data_retrieval">Data retrieval</h7>
<div class="paragraph">
<p>This module is responsible for external data retrieval.
It provides two main functionalities :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>search for data in a distant site with filter criteria</p>
</li>
<li>
<p>download data from a distant site to local folder or a S3 bucket</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It also handles authentication on these sites.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO insert the class diagram class.mmd here
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A DataRetriever is the main object of this module.
It handles the retrieval of external data.
It uses a Provider to interact with external data provider (search and download).
It uses a Storage to store downloaded data.
It uses a DownloadStatus to track download progress.</p>
</div>
<div class="paragraph">
<p>The DataRetriever handles all the business logic.
The technical aspects are handled by Provider, Storage and DownloadStatus.</p>
</div>
<div class="sect7">
<h8 id="_search_for_data">Search for data</h8>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO insert the activity diagram 'search-activity.mmd' here
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A DataProvider can search for data with criteria using the search function.
The Criteria is time period with a start date and an end date.</p>
</div>
<div class="paragraph">
<p>First, the DataProvider ensures its Provider is authenticated.
If not, it tries to log in.
In case of connexion issues, it raises a specific ConnexionFailed exception.
In case of authentication issues, it raises a specific AuthenticationFailed exception.</p>
</div>
<div class="paragraph">
<p>Then, the site asks its Provider to perform the search.
In case of error during search, it raises a specific SearchFailed exception.</p>
</div>
<div class="paragraph">
<p>Finally, it returns an iterable through the found data.
The found Data are product metadata properties (dict-like object).</p>
</div>
</div>
<div class="sect7">
<h8 id="_download_a_data">Download a data</h8>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO insert the activity diagram 'download-activity.mmd' here
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A site can download a file to a specific path from its external id using the download function.</p>
</div>
<div class="paragraph">
<p>First, the site ensures its Provider is authenticated.
If not, it tries to log in.
In case of connexion issues, it raises a specific ConnexionFailed exception.
In case of authentication issues, it raises a specific AuthenticationFailed exception.</p>
</div>
<div class="paragraph">
<p>Then, it updates the download status to indicate the download has started.</p>
</div>
<div class="paragraph">
<p>Then, the site asks its Provider to perform the download.
In case of error during download,
it updates the status with the error information,
and it raises a specific DownloadFailed exception.</p>
</div>
<div class="paragraph">
<p>Then, it asks its Storage to store the downloaded data with its Storage.</p>
</div>
</div>
<div class="sect7">
<h8 id="_provider">Provider</h8>
<div class="paragraph">
<p>The Provider is responsible for technical exchange with the external sites.
It is implemented with <a href="https://eodag.readthedocs.io/en/stable/index.html">EODAG</a> via the EodagProvider.</p>
</div>
</div>
<div class="sect7">
<h8 id="_storage">Storage</h8>
<div class="paragraph">
<p>The Storage is responsible for storing the file.
The main storage is the S3Bucket.</p>
</div>
</div>
<div class="sect7">
<h8 id="_download_status">Download status</h8>
<div class="paragraph">
<p>The DownloadStatus is responsible for tracking download progress.
The status is stored in a postgresql database.
The interaction with this database are handled by the PGDownloadStatus.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_event_layer">Event layer</h5>

</div>
</div>
<div class="sect3">
<h4 id="_services">Services</h4>
<div class="sect4">
<h5 id="_cadip_service">Cadip service</h5>
<div class="paragraph">
<p>The cadip service enables users to retrieve data from cadip stations.
Each instance of this service is started for a given station.</p>
</div>
<div class="paragraph">
<p>It provides 2 endpoints :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a search endpoint that enables to search files for a time period</p>
</li>
<li>
<p>a download endpoint that enables to download a file from its id and name</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The processes are realized by a DataRetriever configured to use the EODAG provider "CADIP".</p>
</div>
<div class="sect5">
<h6 id="_configuration">Configuration</h6>
<div class="paragraph">
<p>This service uses several configurations elements :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the station to url mapping that defines the url of the cadip server for each station</p>
</li>
<li>
<p>the station handled by the instance</p>
</li>
<li>
<p>the eodag configuration used to interact with the cadip station</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_mode_2">Deploy mode</h3>
<div class="paragraph">
<p>A service can be started in several modes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>laptop : monolithic for a local use</p>
</li>
<li>
<p>cluster-api : provide the http endpoint for a cluster use</p>
</li>
<li>
<p>cluster-service : provide the scalable functional service for a cluster use</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This mode is a starting parameter of the service
and it changes how the service will work.</p>
</div>
<div class="sect3">
<h4 id="_laptop">laptop</h4>
<div class="paragraph">
<p>If the service is started locally, the "laptop" mode is used.
In this mode, the api delegates the process of the request direcly to the library.</p>
</div>
<div class="paragraph">
<p>WARN: In this mode, only a request can be handled at a time</p>
</div>
<div class="paragraph">
<p>NOTE : TODO insert the api/component_laptop</p>
</div>
</div>
<div class="sect3">
<h4 id="_cluster">cluster</h4>
<div class="paragraph">
<p>When deploying in a cluster, each service is divided in two part :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A unique "cluster-api" that provides the http endpoint
and delegate the process of the request to an event message bus.</p>
</li>
<li>
<p>A scalable "cluster-service" that consumes the event messages
and uses the library to process the request.
Each instance of this service handles an avent at a time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>NOTE : TODO insert the api/component_cluster</p>
</div>
<div id="navigation">
<table class="tableblock frame-none grid-none stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle"><a href="../background/ci.html">Prev</a></th>
<th class="tableblock halign-center valign-middle"><a href="../../index.html">Up</a><br>
<a href="../../index.html">Home</a></th>
<th class="tableblock halign-right valign-middle"><a href="../doc-generation/description.html">Next</a></th>
</tr>
</thead>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-01-16 10:05:34 UTC
</div>
</div>
</body>
</html>