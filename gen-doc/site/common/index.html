
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../frontend/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.24">
    
    
      
        <title>Common - RSPY</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#rs_server_common.authentication" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="RSPY" class="md-header__button md-logo" aria-label="RSPY" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RSPY
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Common
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="RSPY" class="md-nav__button md-logo" aria-label="RSPY" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    RSPY
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cadip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CADIP
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../adgs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ADGS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../catalog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Catalog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../frontend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Frontend
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Common
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Common
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.authentication" class="md-nav__link">
    <span class="md-ellipsis">
      authentication
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.authentication.__apikey_security_cached" class="md-nav__link">
    <span class="md-ellipsis">
      __apikey_security_cached
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.authentication.apikey_security" class="md-nav__link">
    <span class="md-ellipsis">
      apikey_security
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.authentication.apikey_validator" class="md-nav__link">
    <span class="md-ellipsis">
      apikey_validator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.db.database" class="md-nav__link">
    <span class="md-ellipsis">
      database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager" class="md-nav__link">
    <span class="md-ellipsis">
      DatabaseSessionManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatabaseSessionManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.__filelock" class="md-nav__link">
    <span class="md-ellipsis">
      __filelock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.close" class="md-nav__link">
    <span class="md-ellipsis">
      close
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.connect" class="md-nav__link">
    <span class="md-ellipsis">
      connect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.create_all" class="md-nav__link">
    <span class="md-ellipsis">
      create_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.drop_all" class="md-nav__link">
    <span class="md-ellipsis">
      drop_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.open_session" class="md-nav__link">
    <span class="md-ellipsis">
      open_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.reraise_http_exception" class="md-nav__link">
    <span class="md-ellipsis">
      reraise_http_exception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.session" class="md-nav__link">
    <span class="md-ellipsis">
      session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.url" class="md-nav__link">
    <span class="md-ellipsis">
      url
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.db.database.get_db" class="md-nav__link">
    <span class="md-ellipsis">
      get_db
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.logging" class="md-nav__link">
    <span class="md-ellipsis">
      logging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.logging.CustomFormatter" class="md-nav__link">
    <span class="md-ellipsis">
      CustomFormatter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.logging.Logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.utils.logging.Logging.default" class="md-nav__link">
    <span class="md-ellipsis">
      default
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.opentelemetry" class="md-nav__link">
    <span class="md-ellipsis">
      opentelemetry
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.opentelemetry.init_traces" class="md-nav__link">
    <span class="md-ellipsis">
      init_traces
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.EoDAGDownloadHandler" class="md-nav__link">
    <span class="md-ellipsis">
      EoDAGDownloadHandler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.create_stac_collection" class="md-nav__link">
    <span class="md-ellipsis">
      create_stac_collection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.eodag_download" class="md-nav__link">
    <span class="md-ellipsis">
      eodag_download
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.extract_eo_product" class="md-nav__link">
    <span class="md-ellipsis">
      extract_eo_product
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.is_valid_date_format" class="md-nav__link">
    <span class="md-ellipsis">
      is_valid_date_format
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.odata_to_stac" class="md-nav__link">
    <span class="md-ellipsis">
      odata_to_stac
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.sort_feature_collection" class="md-nav__link">
    <span class="md-ellipsis">
      sort_feature_collection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.update_db" class="md-nav__link">
    <span class="md-ellipsis">
      update_db
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.validate_inputs_format" class="md-nav__link">
    <span class="md-ellipsis">
      validate_inputs_format
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.write_search_products_to_db" class="md-nav__link">
    <span class="md-ellipsis">
      write_search_products_to_db
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider" class="md-nav__link">
    <span class="md-ellipsis">
      eodag_provider
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider" class="md-nav__link">
    <span class="md-ellipsis">
      EodagProvider
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EodagProvider">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      __del__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.create_eodag_product" class="md-nav__link">
    <span class="md-ellipsis">
      create_eodag_product
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.download" class="md-nav__link">
    <span class="md-ellipsis">
      download
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.init_eodag_client" class="md-nav__link">
    <span class="md-ellipsis">
      init_eodag_client
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider" class="md-nav__link">
    <span class="md-ellipsis">
      provider
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.CreateProviderFailed" class="md-nav__link">
    <span class="md-ellipsis">
      CreateProviderFailed
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.DownloadProductFailed" class="md-nav__link">
    <span class="md-ellipsis">
      DownloadProductFailed
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.Product" class="md-nav__link">
    <span class="md-ellipsis">
      Product
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.Provider" class="md-nav__link">
    <span class="md-ellipsis">
      Provider
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Provider">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.Provider.download" class="md-nav__link">
    <span class="md-ellipsis">
      download
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.Provider.search" class="md-nav__link">
    <span class="md-ellipsis">
      search
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.SearchProductFailed" class="md-nav__link">
    <span class="md-ellipsis">
      SearchProductFailed
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.TimeRange" class="md-nav__link">
    <span class="md-ellipsis">
      TimeRange
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TimeRange">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.TimeRange.duration" class="md-nav__link">
    <span class="md-ellipsis">
      duration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler" class="md-nav__link">
    <span class="md-ellipsis">
      s3_storage_handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config" class="md-nav__link">
    <span class="md-ellipsis">
      GetKeysFromS3Config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config" class="md-nav__link">
    <span class="md-ellipsis">
      PutFilesToS3Config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler" class="md-nav__link">
    <span class="md-ellipsis">
      S3StorageHandler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="S3StorageHandler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.__get_s3_client" class="md-nav__link">
    <span class="md-ellipsis">
      __get_s3_client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.check_bucket_access" class="md-nav__link">
    <span class="md-ellipsis">
      check_bucket_access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.check_file_overwriting" class="md-nav__link">
    <span class="md-ellipsis">
      check_file_overwriting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.connect_s3" class="md-nav__link">
    <span class="md-ellipsis">
      connect_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.delete_file_from_s3" class="md-nav__link">
    <span class="md-ellipsis">
      delete_file_from_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.disconnect_s3" class="md-nav__link">
    <span class="md-ellipsis">
      disconnect_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.files_to_be_downloaded" class="md-nav__link">
    <span class="md-ellipsis">
      files_to_be_downloaded
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.files_to_be_uploaded" class="md-nav__link">
    <span class="md-ellipsis">
      files_to_be_uploaded
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_basename" class="md-nav__link">
    <span class="md-ellipsis">
      get_basename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_keys_from_s3" class="md-nav__link">
    <span class="md-ellipsis">
      get_keys_from_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_secrets_from_file" class="md-nav__link">
    <span class="md-ellipsis">
      get_secrets_from_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.list_s3_files_obj" class="md-nav__link">
    <span class="md-ellipsis">
      list_s3_files_obj
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.put_files_to_s3" class="md-nav__link">
    <span class="md-ellipsis">
      put_files_to_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.s3_path_parser" class="md-nav__link">
    <span class="md-ellipsis">
      s3_path_parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.transfer_from_s3_to_s3" class="md-nav__link">
    <span class="md-ellipsis">
      transfer_from_s3_to_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.wait_timeout" class="md-nav__link">
    <span class="md-ellipsis">
      wait_timeout
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.TransferFromS3ToS3Config" class="md-nav__link">
    <span class="md-ellipsis">
      TransferFromS3ToS3Config
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.authentication" class="md-nav__link">
    <span class="md-ellipsis">
      authentication
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.authentication.__apikey_security_cached" class="md-nav__link">
    <span class="md-ellipsis">
      __apikey_security_cached
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.authentication.apikey_security" class="md-nav__link">
    <span class="md-ellipsis">
      apikey_security
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.authentication.apikey_validator" class="md-nav__link">
    <span class="md-ellipsis">
      apikey_validator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.db.database" class="md-nav__link">
    <span class="md-ellipsis">
      database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager" class="md-nav__link">
    <span class="md-ellipsis">
      DatabaseSessionManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatabaseSessionManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.__filelock" class="md-nav__link">
    <span class="md-ellipsis">
      __filelock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.close" class="md-nav__link">
    <span class="md-ellipsis">
      close
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.connect" class="md-nav__link">
    <span class="md-ellipsis">
      connect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.create_all" class="md-nav__link">
    <span class="md-ellipsis">
      create_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.drop_all" class="md-nav__link">
    <span class="md-ellipsis">
      drop_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.open_session" class="md-nav__link">
    <span class="md-ellipsis">
      open_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.reraise_http_exception" class="md-nav__link">
    <span class="md-ellipsis">
      reraise_http_exception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.session" class="md-nav__link">
    <span class="md-ellipsis">
      session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.db.database.DatabaseSessionManager.url" class="md-nav__link">
    <span class="md-ellipsis">
      url
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.db.database.get_db" class="md-nav__link">
    <span class="md-ellipsis">
      get_db
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.logging" class="md-nav__link">
    <span class="md-ellipsis">
      logging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.logging.CustomFormatter" class="md-nav__link">
    <span class="md-ellipsis">
      CustomFormatter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.logging.Logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.utils.logging.Logging.default" class="md-nav__link">
    <span class="md-ellipsis">
      default
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.opentelemetry" class="md-nav__link">
    <span class="md-ellipsis">
      opentelemetry
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.opentelemetry.init_traces" class="md-nav__link">
    <span class="md-ellipsis">
      init_traces
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.EoDAGDownloadHandler" class="md-nav__link">
    <span class="md-ellipsis">
      EoDAGDownloadHandler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.create_stac_collection" class="md-nav__link">
    <span class="md-ellipsis">
      create_stac_collection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.eodag_download" class="md-nav__link">
    <span class="md-ellipsis">
      eodag_download
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.extract_eo_product" class="md-nav__link">
    <span class="md-ellipsis">
      extract_eo_product
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.is_valid_date_format" class="md-nav__link">
    <span class="md-ellipsis">
      is_valid_date_format
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.odata_to_stac" class="md-nav__link">
    <span class="md-ellipsis">
      odata_to_stac
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.sort_feature_collection" class="md-nav__link">
    <span class="md-ellipsis">
      sort_feature_collection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.update_db" class="md-nav__link">
    <span class="md-ellipsis">
      update_db
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.validate_inputs_format" class="md-nav__link">
    <span class="md-ellipsis">
      validate_inputs_format
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.utils.utils.write_search_products_to_db" class="md-nav__link">
    <span class="md-ellipsis">
      write_search_products_to_db
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider" class="md-nav__link">
    <span class="md-ellipsis">
      eodag_provider
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider" class="md-nav__link">
    <span class="md-ellipsis">
      EodagProvider
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EodagProvider">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      __del__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.create_eodag_product" class="md-nav__link">
    <span class="md-ellipsis">
      create_eodag_product
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.download" class="md-nav__link">
    <span class="md-ellipsis">
      download
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.eodag_provider.EodagProvider.init_eodag_client" class="md-nav__link">
    <span class="md-ellipsis">
      init_eodag_client
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider" class="md-nav__link">
    <span class="md-ellipsis">
      provider
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.CreateProviderFailed" class="md-nav__link">
    <span class="md-ellipsis">
      CreateProviderFailed
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.DownloadProductFailed" class="md-nav__link">
    <span class="md-ellipsis">
      DownloadProductFailed
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.Product" class="md-nav__link">
    <span class="md-ellipsis">
      Product
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.Provider" class="md-nav__link">
    <span class="md-ellipsis">
      Provider
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Provider">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.Provider.download" class="md-nav__link">
    <span class="md-ellipsis">
      download
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.Provider.search" class="md-nav__link">
    <span class="md-ellipsis">
      search
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.SearchProductFailed" class="md-nav__link">
    <span class="md-ellipsis">
      SearchProductFailed
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.TimeRange" class="md-nav__link">
    <span class="md-ellipsis">
      TimeRange
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TimeRange">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.data_retrieval.provider.TimeRange.duration" class="md-nav__link">
    <span class="md-ellipsis">
      duration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler" class="md-nav__link">
    <span class="md-ellipsis">
      s3_storage_handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config" class="md-nav__link">
    <span class="md-ellipsis">
      GetKeysFromS3Config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config" class="md-nav__link">
    <span class="md-ellipsis">
      PutFilesToS3Config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler" class="md-nav__link">
    <span class="md-ellipsis">
      S3StorageHandler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="S3StorageHandler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.__get_s3_client" class="md-nav__link">
    <span class="md-ellipsis">
      __get_s3_client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.check_bucket_access" class="md-nav__link">
    <span class="md-ellipsis">
      check_bucket_access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.check_file_overwriting" class="md-nav__link">
    <span class="md-ellipsis">
      check_file_overwriting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.connect_s3" class="md-nav__link">
    <span class="md-ellipsis">
      connect_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.delete_file_from_s3" class="md-nav__link">
    <span class="md-ellipsis">
      delete_file_from_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.disconnect_s3" class="md-nav__link">
    <span class="md-ellipsis">
      disconnect_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.files_to_be_downloaded" class="md-nav__link">
    <span class="md-ellipsis">
      files_to_be_downloaded
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.files_to_be_uploaded" class="md-nav__link">
    <span class="md-ellipsis">
      files_to_be_uploaded
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_basename" class="md-nav__link">
    <span class="md-ellipsis">
      get_basename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_keys_from_s3" class="md-nav__link">
    <span class="md-ellipsis">
      get_keys_from_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_secrets_from_file" class="md-nav__link">
    <span class="md-ellipsis">
      get_secrets_from_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.list_s3_files_obj" class="md-nav__link">
    <span class="md-ellipsis">
      list_s3_files_obj
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.put_files_to_s3" class="md-nav__link">
    <span class="md-ellipsis">
      put_files_to_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.s3_path_parser" class="md-nav__link">
    <span class="md-ellipsis">
      s3_path_parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.transfer_from_s3_to_s3" class="md-nav__link">
    <span class="md-ellipsis">
      transfer_from_s3_to_s3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.wait_timeout" class="md-nav__link">
    <span class="md-ellipsis">
      wait_timeout
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rs_server_common.s3_storage_handler.s3_storage_handler.TransferFromS3ToS3Config" class="md-nav__link">
    <span class="md-ellipsis">
      TransferFromS3ToS3Config
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Common</h1>

<div class="doc doc-object doc-module">



<a id="rs_server_common.authentication"></a>
    <div class="doc doc-contents first">

      <p>Authentication functions implementation.</p>
<p>Note: calls https://gitlab.si.c-s.fr/space_applications/eoservices/apikey-manager</p>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="rs_server_common.authentication.__apikey_security_cached" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__apikey_security_cached</span><span class="p">(</span><span class="n">apikey_value</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

      <p>Cached version of apikey_security. Cache an infinite (sys.maxsize) number of results for 120 seconds.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/authentication.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@cached</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="n">ttl_cache</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">__apikey_security_cached</span><span class="p">(</span><span class="n">apikey_value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cached version of apikey_security. Cache an infinite (sys.maxsize) number of results for 120 seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The uac manager check url is passed as an environment variable</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">check_url</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;RSPY_UAC_CHECK_URL&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span> <span class="s2">&quot;UAC manager URL is undefined&quot;</span><span class="p">)</span>  <span class="c1"># pylint: disable=raise-missing-from</span>

    <span class="c1"># Request the uac, pass user-defined api key in http header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">settings</span><span class="o">.</span><span class="n">http_client</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">check_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="n">APIKEY_HEADER</span><span class="p">:</span> <span class="n">apikey_value</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Error connecting to the UAC manager&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>

    <span class="c1"># Read the api key info</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="c1"># Note: for now, config is an empty dict</span>
        <span class="k">return</span> <span class="n">contents</span><span class="p">[</span><span class="s2">&quot;iam_roles&quot;</span><span class="p">],</span> <span class="n">contents</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">],</span> <span class="n">contents</span><span class="p">[</span><span class="s2">&quot;user_login&quot;</span><span class="p">]</span>

    <span class="c1"># Try to read the response detail or error</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;detail&quot;</span> <span class="ow">in</span> <span class="n">json</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>

    <span class="c1"># If this fail, get the full response content</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-exception-caught</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="c1"># Forward error</span>
    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;UAC manager: </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.authentication.apikey_security" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apikey_security</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">apikey_header</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

      <p>FastAPI Security dependency for the cluster mode. Check the api key validity, passed as an HTTP header.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>apikey_header</code></td>
            <td>
                  <code><span title="fastapi.Security">Security</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>API key passed in HTTP header</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>tuple[list, dict, str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (IAM roles, config) information from the keycloak server, associated with the api key.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/authentication.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">apikey_security</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">apikey_header</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">APIKEY_AUTH_HEADER</span><span class="p">)],</span>
    <span class="c1"># apikey_query: Annotated[str, Security(APIKEY_AUTH_QUERY)],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FastAPI Security dependency for the cluster mode. Check the api key validity, passed as an HTTP header.</span>

<span class="sd">    Args:</span>
<span class="sd">        apikey_header (Security): API key passed in HTTP header</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (IAM roles, config) information from the keycloak server, associated with the api key.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Use the api key passed by either http headers or query parameter (disabled for now)</span>
    <span class="n">apikey_value</span> <span class="o">=</span> <span class="n">apikey_header</span>  <span class="c1"># or apikey_query</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">apikey_value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not authenticated&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Call the cached function (fastapi Depends doesn&#39;t work with @cached)</span>
    <span class="n">auth_roles</span><span class="p">,</span> <span class="n">auth_config</span><span class="p">,</span> <span class="n">user_login</span> <span class="o">=</span> <span class="k">await</span> <span class="n">__apikey_security_cached</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">apikey_value</span><span class="p">))</span>
    <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_roles</span> <span class="o">=</span> <span class="n">auth_roles</span>
    <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_config</span> <span class="o">=</span> <span class="n">auth_config</span>
    <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">user_login</span> <span class="o">=</span> <span class="n">user_login</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API key information: </span><span class="si">{</span><span class="n">auth_roles</span><span class="p">,</span><span class="w"> </span><span class="n">auth_config</span><span class="p">,</span><span class="w"> </span><span class="n">user_login</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_roles</span><span class="p">,</span> <span class="n">auth_config</span><span class="p">,</span> <span class="n">user_login</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.authentication.apikey_validator" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apikey_validator</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">access_type</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Decorator to validate API key access.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>station</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The station name = adgs or cadip</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>access_type</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of access.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="fastapi.HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the authorization key does not include the right role
to access the specified station.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>function</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Decorator function.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/authentication.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">apikey_validator</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">access_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to validate API key access.</span>

<span class="sd">    Args:</span>
<span class="sd">        station (str): The station name = adgs or cadip</span>
<span class="sd">        access_type (str): The type of access.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If the authorization key does not include the right role</span>
<span class="sd">            to access the specified station.</span>

<span class="sd">    Returns:</span>
<span class="sd">        function: Decorator function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">CLUSTER_MODE</span><span class="p">:</span>
                <span class="c1"># Read the full cadip station passed in parameter e.g. INS, MPS, ...</span>
                <span class="k">if</span> <span class="n">station</span> <span class="o">==</span> <span class="s2">&quot;cadip&quot;</span><span class="p">:</span>
                    <span class="n">cadip_station</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>  <span class="c1"># ins, mps, mti, nsg, sgs, or cadip</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">full_station</span> <span class="o">=</span> <span class="n">STATIONS_AUTH_LUT</span><span class="p">[</span><span class="n">cadip_station</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
                            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unknown CADIP station: </span><span class="si">{</span><span class="n">cadip_station</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span> <span class="kn">from</span> <span class="nn">exception</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># for adgs</span>
                    <span class="n">full_station</span> <span class="o">=</span> <span class="n">station</span>

                <span class="n">requested_role</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rs_</span><span class="si">{</span><span class="n">full_station</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">access_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">auth_roles</span> <span class="o">=</span> <span class="p">[</span><span class="n">role</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_roles</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">auth_roles</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">requested_role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">auth_roles</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Authorization key does not include the right role to </span><span class="si">{</span><span class="n">access_type</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;from the </span><span class="si">{</span><span class="n">full_station</span><span class="si">!r}</span><span class="s2"> station&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="rs_server_common.db.database"></a>
    <div class="doc doc-contents first">

      <p>Database connection.</p>
<p>Taken from: https://praciano.com.br/fastapi-and-async-sqlalchemy-20-with-pytest-done-right.html</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="rs_server_common.db.database.DatabaseSessionManager" class="doc doc-heading">
            <code>DatabaseSessionManager</code>


</h2>


    <div class="doc doc-contents ">


      <p>Database session configuration.</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DatabaseSessionManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database session configuration.&quot;&quot;&quot;</span>

    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="n">multiprocessing_lock</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Database session configuration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">:</span> <span class="n">Engine</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span><span class="p">:</span> <span class="n">sessionmaker</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get database connection URL.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># pylint: disable=consider-using-f-string</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
                <span class="s2">&quot;POSTGRES_URL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{user}</span><span class="s2">:</span><span class="si">{password}</span><span class="s2">@</span><span class="si">{host}</span><span class="s2">:</span><span class="si">{port}</span><span class="s2">/</span><span class="si">{dbname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">],</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">],</span>
                    <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_HOST&quot;</span><span class="p">],</span>
                    <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">],</span>
                    <span class="n">dbname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">],</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">key_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s2">&quot;The PostgreSQL environment variables are missing: &quot;</span>
                <span class="s2">&quot;POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_HOST, POSTGRES_PORT, POSTGRES_DB&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">key_error</span>

    <span class="k">def</span> <span class="nf">open_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open database session.&quot;&quot;&quot;</span>

        <span class="c1"># If the &#39;self&#39; object is used by several threads in the same process,</span>
        <span class="c1"># make sure to initialize the session only once.</span>
        <span class="k">with</span> <span class="n">DatabaseSessionManager</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">(),</span> <span class="n">poolclass</span><span class="o">=</span><span class="n">NullPool</span><span class="p">,</span> <span class="n">pool_pre_ping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create all tables.</span>
                    <span class="c1"># Warning: this only works if the database table modules have been imported</span>
                    <span class="c1"># e.g. import rs_server_adgs.adgs_download_status</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

                <span class="c1"># It fails if the database is unreachable, but even in this case the engine and session are not None.</span>
                <span class="c1"># Set them to None so we will try to create all tables again on the next try.</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close database session.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Connection</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open new database connection instance.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;DatabaseSessionManager is not initialized&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">connection</span>

            <span class="c1"># In case of any exception, rollback connection and re-raise into HTTP exception</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-exception-caught</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reraise_http_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open new database session instance.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;DatabaseSessionManager is not initialized&quot;</span><span class="p">)</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>

        <span class="c1"># In case of any exception, rollback session and re-raise into HTTP exception</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-exception-caught</span>
            <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reraise_http_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

        <span class="c1"># Close session when deleting instance.</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__filelock</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Avoid concurrent writing to the database using a file locK.&quot;&quot;&quot;</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">with_filelock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Wrap the the call to &#39;func&#39; inside the lock.&quot;&quot;&quot;</span>

            <span class="c1"># Let&#39;s do this only if the RSPY_WORKING_DIR environment variable is defined.</span>
            <span class="c1"># Write a .lock file inside this directory.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;RSPY_WORKING_DIR&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.lock&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Else just call the function without a lock</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">with_filelock</span>

    <span class="nd">@__filelock</span>
    <span class="k">def</span> <span class="nf">create_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create all database tables.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">DatabaseSessionManager</span><span class="o">.</span><span class="n">multiprocessing_lock</span><span class="p">:</span>  <span class="c1"># Handle concurrent table creation by different processes</span>
            <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">)</span>

    <span class="nd">@__filelock</span>
    <span class="k">def</span> <span class="nf">drop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop all database tables.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">DatabaseSessionManager</span><span class="o">.</span><span class="n">multiprocessing_lock</span><span class="p">:</span>  <span class="c1"># Handle concurrent table creation by different processes</span>
            <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reraise_http_exception</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Re-raise all exceptions into HTTP exceptions.&quot;&quot;&quot;</span>

        <span class="c1"># Raised exceptions are not always printed in the console, so do it manually with the stacktrace.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">StarletteHTTPException</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.__filelock" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__filelock</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Avoid concurrent writing to the database using a file locK.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">__filelock</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Avoid concurrent writing to the database using a file locK.&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">with_filelock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap the the call to &#39;func&#39; inside the lock.&quot;&quot;&quot;</span>

        <span class="c1"># Let&#39;s do this only if the RSPY_WORKING_DIR environment variable is defined.</span>
        <span class="c1"># Write a .lock file inside this directory.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;RSPY_WORKING_DIR&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.lock&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Else just call the function without a lock</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">with_filelock</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Create a Database session configuration.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Database session configuration.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">:</span> <span class="n">Engine</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span><span class="p">:</span> <span class="n">sessionmaker</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.close" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">close</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Close database session.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close database session.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.connect" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Open new database connection instance.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Connection</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open new database connection instance.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;DatabaseSessionManager is not initialized&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">connection</span>

        <span class="c1"># In case of any exception, rollback connection and re-raise into HTTP exception</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-exception-caught</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reraise_http_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.create_all" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_all</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Create all database tables.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@__filelock</span>
<span class="k">def</span> <span class="nf">create_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create all database tables.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">DatabaseSessionManager</span><span class="o">.</span><span class="n">multiprocessing_lock</span><span class="p">:</span>  <span class="c1"># Handle concurrent table creation by different processes</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.drop_all" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">drop_all</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Drop all database tables.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@__filelock</span>
<span class="k">def</span> <span class="nf">drop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drop all database tables.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">DatabaseSessionManager</span><span class="o">.</span><span class="n">multiprocessing_lock</span><span class="p">:</span>  <span class="c1"># Handle concurrent table creation by different processes</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.open_session" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">open_session</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Open database session.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">open_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open database session.&quot;&quot;&quot;</span>

    <span class="c1"># If the &#39;self&#39; object is used by several threads in the same process,</span>
    <span class="c1"># make sure to initialize the session only once.</span>
    <span class="k">with</span> <span class="n">DatabaseSessionManager</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">(),</span> <span class="n">poolclass</span><span class="o">=</span><span class="n">NullPool</span><span class="p">,</span> <span class="n">pool_pre_ping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create all tables.</span>
                <span class="c1"># Warning: this only works if the database table modules have been imported</span>
                <span class="c1"># e.g. import rs_server_adgs.adgs_download_status</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

            <span class="c1"># It fails if the database is unreachable, but even in this case the engine and session are not None.</span>
            <span class="c1"># Set them to None so we will try to create all tables again on the next try.</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.reraise_http_exception" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reraise_http_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Re-raise all exceptions into HTTP exceptions.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">reraise_http_exception</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Re-raise all exceptions into HTTP exceptions.&quot;&quot;&quot;</span>

    <span class="c1"># Raised exceptions are not always printed in the console, so do it manually with the stacktrace.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">StarletteHTTPException</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exception</span>
    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.session" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">session</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Open new database session instance.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open new database session instance.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;DatabaseSessionManager is not initialized&quot;</span><span class="p">)</span>

    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessionmaker</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">session</span>

    <span class="c1"># In case of any exception, rollback session and re-raise into HTTP exception</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-exception-caught</span>
        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reraise_http_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

    <span class="c1"># Close session when deleting instance.</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.db.database.DatabaseSessionManager.url" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">url</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Get database connection URL.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get database connection URL.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># pylint: disable=consider-using-f-string</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
            <span class="s2">&quot;POSTGRES_URL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{user}</span><span class="s2">:</span><span class="si">{password}</span><span class="s2">@</span><span class="si">{host}</span><span class="s2">:</span><span class="si">{port}</span><span class="s2">/</span><span class="si">{dbname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">],</span>
                <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">],</span>
                <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_HOST&quot;</span><span class="p">],</span>
                <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">],</span>
                <span class="n">dbname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">key_error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
            <span class="s2">&quot;The PostgreSQL environment variables are missing: &quot;</span>
            <span class="s2">&quot;POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_HOST, POSTGRES_PORT, POSTGRES_DB&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">key_error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="rs_server_common.db.database.get_db" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_db</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Return a database session for FastAPI dependency injection.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/db/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a database session for FastAPI dependency injection.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">sessionmanager</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>

    <span class="c1"># Re-raise all exceptions into HTTP exceptions</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-exception-caught</span>
        <span class="n">DatabaseSessionManager</span><span class="o">.</span><span class="n">reraise_http_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="rs_server_common.utils.logging"></a>
    <div class="doc doc-contents first">

      <p>Logging utility.</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="rs_server_common.utils.logging.CustomFormatter" class="doc doc-heading">
            <code>CustomFormatter</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="logging.Formatter">Formatter</span></code></p>


      <p>Custom logging formatter with colored text.
See: https://stackoverflow.com/a/56944256</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/utils/logging.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CustomFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom logging formatter with colored text.</span>
<span class="sd">    See: https://stackoverflow.com/a/56944256</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_RED</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[31m&quot;</span>
    <span class="n">_BOLD_RED</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[31;1m&quot;</span>
    <span class="n">_GREEN</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[32m&quot;</span>
    <span class="n">_YELLOW</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[33m&quot;</span>
    <span class="n">_PURPLE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[35m&quot;</span>
    <span class="n">_RESET</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span>

    <span class="n">_FORMAT</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;%(asctime)s.%(msecs)03d [</span><span class="se">{{</span><span class="s2">color</span><span class="se">}}</span><span class="s2">%(levelname)s</span><span class="si">{</span><span class="n">_RESET</span><span class="si">}</span><span class="s2">] (%(name)s) %(message)s&quot;</span>
    <span class="n">_DATETIME</span> <span class="o">=</span> <span class="s2">&quot;%H:%M:%S&quot;</span>

    <span class="n">_FORMATS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span> <span class="n">_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span> <span class="n">_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">_PURPLE</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span> <span class="n">_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">_GREEN</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span> <span class="n">_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">_YELLOW</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">_BOLD_RED</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span> <span class="n">_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">_RED</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">level_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FORMATS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelno</span><span class="p">)</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">level_format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATETIME</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.utils.logging.Logging" class="doc doc-heading">
            <code>Logging</code>


</h2>


    <div class="doc doc-contents ">


      <p>Logging utility.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.logging.Logging.lock">lock</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For code synchronization</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.logging.Logging.level">level</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimal log level to use for all new logging instances.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/utils/logging.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Logging</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logging utility.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        lock: For code synchronization</span>
<span class="sd">        level: Minimal log level to use for all new logging instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rspy&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a default Logger class instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Logger name. You can pass __name__ to use your current module name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Don&#39;t propagate to root logger</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># If we have already set the handlers for the logger with this name, do nothing more</span>
            <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">logger</span>

            <span class="c1"># Set the minimal log level to use for all new logging instances.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>

            <span class="c1"># Create console handler</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">CustomFormatter</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

            <span class="c1"># Export logs to Loki, see: https://pypi.org/project/python-logging-loki/</span>
            <span class="c1"># Note: on the cluster, this is not used. Promtail already forwards stdout to Loki.</span>
            <span class="n">loki_endpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOKI_ENDPOINT&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loki_endpoint</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">:</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">logging_loki</span><span class="o">.</span><span class="n">LokiQueueHandler</span><span class="p">(</span>
                    <span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">loki_endpoint</span><span class="p">,</span>
                    <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">},</span>
                    <span class="c1"># auth=(&quot;username&quot;, &quot;password&quot;),</span>
                    <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">CustomFormatter</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">logger</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="rs_server_common.utils.logging.Logging.default" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rspy&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Return a default Logger class instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>name</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger name. You can pass <strong>name</strong> to use your current module name.</p>
              </div>
            </td>
            <td>
                  <code>&#39;rspy&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/logging.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rspy&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a default Logger class instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Logger name. You can pass __name__ to use your current module name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="c1"># Don&#39;t propagate to root logger</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># If we have already set the handlers for the logger with this name, do nothing more</span>
        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">logger</span>

        <span class="c1"># Set the minimal log level to use for all new logging instances.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>

        <span class="c1"># Create console handler</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">CustomFormatter</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="c1"># Export logs to Loki, see: https://pypi.org/project/python-logging-loki/</span>
        <span class="c1"># Note: on the cluster, this is not used. Promtail already forwards stdout to Loki.</span>
        <span class="n">loki_endpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOKI_ENDPOINT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loki_endpoint</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging_loki</span><span class="o">.</span><span class="n">LokiQueueHandler</span><span class="p">(</span>
                <span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">url</span><span class="o">=</span><span class="n">loki_endpoint</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">},</span>
                <span class="c1"># auth=(&quot;username&quot;, &quot;password&quot;),</span>
                <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">CustomFormatter</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">logger</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="rs_server_common.utils.opentelemetry"></a>
    <div class="doc doc-contents first">

      <p>OpenTelemetry utility</p>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.opentelemetry.init_traces" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">init_traces</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">service_name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Init instrumentation of OpenTelemetry traces.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>app</code></td>
            <td>
                  <code><span title="fastapi.FastAPI">FastAPI</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>FastAPI application</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>service_name</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>service name</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/opentelemetry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">init_traces</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">fastapi</span><span class="o">.</span><span class="n">FastAPI</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Init instrumentation of OpenTelemetry traces.</span>

<span class="sd">    Args:</span>
<span class="sd">        app (fastapi.FastAPI): FastAPI application</span>
<span class="sd">        service_name (str): service name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># See: https://github.com/softwarebloat/python-tracing-demo/tree/main</span>

    <span class="n">tempo_endpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TEMPO_ENDPOINT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tempo_endpoint</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">otel_resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;service.name&quot;</span><span class="p">:</span> <span class="n">service_name</span><span class="p">})</span>
    <span class="n">otel_tracer</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="n">otel_resource</span><span class="p">)</span>
    <span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">otel_tracer</span><span class="p">)</span>
    <span class="n">otel_tracer</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">BatchSpanProcessor</span><span class="p">(</span><span class="n">OTLPSpanExporter</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">tempo_endpoint</span><span class="p">)))</span>

    <span class="n">FastAPIInstrumentor</span><span class="o">.</span><span class="n">instrument_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">tracer_provider</span><span class="o">=</span><span class="n">otel_tracer</span><span class="p">)</span>
    <span class="c1"># logger.debug(f&quot;OpenTelemetry instrumentation of &#39;fastapi.FastAPIInstrumentor&#39;&quot;)</span>

    <span class="c1"># Instrument all the dependencies under opentelemetry.instrumentation.*</span>
    <span class="c1"># NOTE: we need &#39;poetry run opentelemetry-bootstrap -a install&#39; to install these.</span>

    <span class="n">package</span> <span class="o">=</span> <span class="n">opentelemetry</span><span class="o">.</span><span class="n">instrumentation</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># We need an empty PYTHONPATH if the env var is missing</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Recursively find all package modules</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">module_str</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">walk_packages</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">__path__</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Don&#39;t instrument these modules, they have errors, maybe we should see why</span>
        <span class="k">if</span> <span class="n">module_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;opentelemetry.instrumentation.tortoiseorm&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="c1"># Import and find all module classes</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">module_str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_str</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">_class</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">_class</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Save the class (classes are found several times when imported by other modules)</span>
            <span class="n">classes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_class</span><span class="p">)</span>

            <span class="c1"># Don&#39;t instrument these classes, they have errors, maybe we should see why</span>
            <span class="k">if</span> <span class="n">_class</span> <span class="ow">in</span> <span class="p">[</span><span class="n">AsyncioInstrumentor</span><span class="p">,</span> <span class="n">AwsLambdaInstrumentor</span><span class="p">,</span> <span class="n">BaseInstrumentor</span><span class="p">,</span> <span class="n">FastAPIInstrumentor</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c1"># If the &quot;instrument&quot; method exists, call it</span>
            <span class="n">_instrument</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_class</span><span class="p">,</span> <span class="s2">&quot;instrument&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">_instrument</span><span class="p">):</span>

                <span class="n">_class_instance</span> <span class="o">=</span> <span class="n">_class</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_class_instance</span><span class="o">.</span><span class="n">is_instrumented_by_opentelemetry</span><span class="p">:</span>
                    <span class="n">_class_instance</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">tracer_provider</span><span class="o">=</span><span class="n">otel_tracer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="rs_server_common.utils.utils"></a>
    <div class="doc doc-contents first">

      <p>This module is used to share common functions between apis endpoints</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="rs_server_common.utils.utils.EoDAGDownloadHandler" class="doc doc-heading">
            <code>EoDAGDownloadHandler</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>Dataclass to store arguments needed for eodag download.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.utils.EoDAGDownloadHandler.db_handler">db_handler</span></code></td>
            <td>
                  <code><span title="rs_server_common.db.models.download_status.DownloadStatus">DownloadStatus</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance used to access the database.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.utils.EoDAGDownloadHandler.thread_started">thread_started</span></code></td>
            <td>
                  <code><span title="threading.Event">Event</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Event to signal the start of the download thread.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.utils.EoDAGDownloadHandler.station">station</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Station identifier (needed only for CADIP).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.utils.EoDAGDownloadHandler.product_id">product_id</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Identifier of the product to be downloaded.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.utils.EoDAGDownloadHandler.name">name</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filename of the file to be downloaded.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.utils.EoDAGDownloadHandler.local">local</span></code></td>
            <td>
                  <code>str | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Local path where the product will be stored</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.utils.utils.EoDAGDownloadHandler.obs">obs</span></code></td>
            <td>
                  <code>str | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the S3 storage where the file will be uploaded</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">EoDAGDownloadHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataclass to store arguments needed for eodag download.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db_handler (DownloadStatus): An instance used to access the database.</span>
<span class="sd">        thread_started (threading.Event): Event to signal the start of the download thread.</span>
<span class="sd">        station (str): Station identifier (needed only for CADIP).</span>
<span class="sd">        product_id (str): Identifier of the product to be downloaded.</span>
<span class="sd">        name (str): Filename of the file to be downloaded.</span>
<span class="sd">        local (str | None): Local path where the product will be stored</span>
<span class="sd">        obs (str | None): Path to the S3 storage where the file will be uploaded</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db_handler</span><span class="p">:</span> <span class="n">DownloadStatus</span>
    <span class="n">thread_started</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span>
    <span class="n">station</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># needed only for CADIP</span>
    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">local</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">obs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.create_stac_collection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_stac_collection</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">feature_template</span><span class="p">,</span> <span class="n">stac_mapper</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>This function create a STAC feature for each EOProduct based on a given template</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_stac_collection</span><span class="p">(</span><span class="n">products</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EOProduct</span><span class="p">],</span> <span class="n">feature_template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">stac_mapper</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function create a STAC feature for each EOProduct based on a given template&quot;&quot;&quot;</span>
    <span class="n">stac_template</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;numberMatched&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;numberReturned&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
        <span class="n">product_data</span> <span class="o">=</span> <span class="n">extract_eo_product</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">stac_mapper</span><span class="p">)</span>
        <span class="n">feature_tmp</span> <span class="o">=</span> <span class="n">odata_to_stac</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">feature_template</span><span class="p">),</span> <span class="n">product_data</span><span class="p">,</span> <span class="n">stac_mapper</span><span class="p">)</span>
        <span class="n">stac_template</span><span class="p">[</span><span class="s2">&quot;numberMatched&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">stac_template</span><span class="p">[</span><span class="s2">&quot;numberReturned&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">stac_template</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_tmp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stac_template</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.eodag_download" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">eodag_download</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">init_provider</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Start the eodag download process.</p>
<p>This function initiates the eodag download process using the provided arguments. It sets up
the necessary configurations, starts the download thread, and updates the download status in the
database based on the outcome of the download.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>argument</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="rs_server_common.utils.utils.EoDAGDownloadHandler" href="#rs_server_common.utils.utils.EoDAGDownloadHandler">EoDAGDownloadHandler</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of EoDAGDownloadHandler containing
the arguments used in the downloading process</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The local and obs parameters are optionals:
- local (str | None): Local path where the product will be stored. If this
    parameter is not given, the local path where the file is stored will be set to a temporary one
- obs (str | None): Path to S3 storage where the file will be uploaded, after a successfull download from CADIP
    server. If this parameter is not given, the file will not be uploaded to the s3 storage.</p>
</details>

    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>RuntimeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If there is an issue connecting to the S3 storage during the download.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">eodag_download</span><span class="p">(</span><span class="n">argument</span><span class="p">:</span> <span class="n">EoDAGDownloadHandler</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">init_provider</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Provider</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the eodag download process.</span>

<span class="sd">    This function initiates the eodag download process using the provided arguments. It sets up</span>
<span class="sd">    the necessary configurations, starts the download thread, and updates the download status in the</span>
<span class="sd">    database based on the outcome of the download.</span>

<span class="sd">    Args:</span>
<span class="sd">        argument (EoDAGDownloadHandler): An instance of EoDAGDownloadHandler containing</span>
<span class="sd">         the arguments used in the downloading process</span>

<span class="sd">    Note:</span>
<span class="sd">        The local and obs parameters are optionals:</span>
<span class="sd">        - local (str | None): Local path where the product will be stored. If this</span>
<span class="sd">            parameter is not given, the local path where the file is stored will be set to a temporary one</span>
<span class="sd">        - obs (str | None): Path to S3 storage where the file will be uploaded, after a successfull download from CADIP</span>
<span class="sd">            server. If this parameter is not given, the file will not be uploaded to the s3 storage.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If there is an issue connecting to the S3 storage during the download.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Open a database sessions in this thread, because the session from the root thread may have closed.</span>
    <span class="c1"># Get the product download status</span>

    <span class="n">db_product</span> <span class="o">=</span> <span class="n">argument</span><span class="o">.</span><span class="n">db_handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">argument</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># init eodag object</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">: Thread started !&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="n">setup_logging</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">no_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># tempfile to be used here</span>

        <span class="c1"># Update the status to IN_PROGRESS in the database</span>
        <span class="n">db_product</span><span class="o">.</span><span class="n">in_progress</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">local</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">argument</span><span class="o">.</span><span class="n">local</span> <span class="k">else</span> <span class="n">argument</span><span class="o">.</span><span class="n">local</span>
        <span class="c1"># notify the main thread that the download will be started</span>
        <span class="c1"># To be discussed: init_provider may fail, but in the same time it takes too much</span>
        <span class="c1"># when properly initialized, and the timeout for download endpoint return is overpassed</span>
        <span class="n">argument</span><span class="o">.</span><span class="n">thread_started</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">init_provider</span><span class="p">(</span><span class="n">argument</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">/</span> <span class="n">argument</span><span class="o">.</span><span class="n">name</span>
        <span class="n">provider</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">argument</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> : File: </span><span class="si">%s</span><span class="s2"> downloaded in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span>
            <span class="n">argument</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">init</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-exception-caught</span>
        <span class="c1"># Pylint disabled since error is logged here.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">: Exception caught: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">exception</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Try n times to update the status to FAILED in the database</span>
        <span class="n">update_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">db_product</span><span class="p">,</span> <span class="n">EDownloadStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">argument</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># NOTE: The environment variables have to be set from outside</span>
            <span class="c1"># otherwise the connection with the s3 endpoint fails</span>
            <span class="c1"># TODO: the secrets should be set through env vars</span>
            <span class="c1"># pylint: disable=pointless-string-statement</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            secrets = {</span>
<span class="sd">                &quot;s3endpoint&quot;: None,</span>
<span class="sd">                &quot;accesskey&quot;: None,</span>
<span class="sd">                &quot;secretkey&quot;: None,</span>
<span class="sd">            }</span>
<span class="sd">            S3StorageHandler.get_secrets_from_file(secrets, &quot;/home/&quot; + os.environ[&quot;USER&quot;] + &quot;/.s3cfg&quot;)</span>
<span class="sd">            os.environ[&quot;S3_ACCESSKEY&quot;] = secrets[&quot;accesskey&quot;]</span>
<span class="sd">            os.environ[&quot;S3_SECRETKEY&quot;] = secrets[&quot;secretkey&quot;]</span>
<span class="sd">            os.environ[&quot;S3_ENDPOINT&quot;] = secrets[&quot;s3endpoint&quot;]</span>
<span class="sd">            os.environ[&quot;S3_REGION&quot;] = &quot;sbg&quot;</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">s3_handler</span> <span class="o">=</span> <span class="n">S3StorageHandler</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;S3_ACCESSKEY&quot;</span><span class="p">],</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;S3_SECRETKEY&quot;</span><span class="p">],</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;S3_ENDPOINT&quot;</span><span class="p">],</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;S3_REGION&quot;</span><span class="p">],</span>  <span class="c1"># &quot;sbg&quot;,</span>
            <span class="p">)</span>
            <span class="n">obs_array</span> <span class="o">=</span> <span class="n">argument</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>  <span class="c1"># s3://bucket/path/to</span>
            <span class="n">s3_config</span> <span class="o">=</span> <span class="n">PutFilesToS3Config</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)],</span>
                <span class="n">obs_array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obs_array</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span>
            <span class="p">)</span>
            <span class="n">s3_handler</span><span class="o">.</span><span class="n">put_files_to_s3</span><span class="p">(</span><span class="n">s3_config</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not connect to the s3 storage: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Try n times to update the status to FAILED in the database</span>
            <span class="n">update_db</span><span class="p">(</span>
                <span class="n">db</span><span class="p">,</span>
                <span class="n">db_product</span><span class="p">,</span>
                <span class="n">EDownloadStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                <span class="s2">&quot;Could not connect to the s3 storage&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;General exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Try n times to update the status to DONE in the database</span>
    <span class="n">update_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">db_product</span><span class="p">,</span> <span class="n">EDownloadStatus</span><span class="o">.</span><span class="n">DONE</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Download finished succesfully for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">db_product</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.extract_eo_product" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_eo_product</span><span class="p">(</span><span class="n">eo_product</span><span class="p">,</span> <span class="n">mapper</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>This function is creating key:value pairs from an EOProduct properties</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extract_eo_product</span><span class="p">(</span><span class="n">eo_product</span><span class="p">:</span> <span class="n">EOProduct</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function is creating key:value pairs from an EOProduct properties&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">eo_product</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.is_valid_date_format" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_valid_date_format</span><span class="p">(</span><span class="n">date</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Check if a string adheres to the expected date format "YYYY-MM-DDTHH:MM:SS.sssZ".</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>date</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The string to be validated for the specified date format.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the input string adheres to the expected date format, otherwise False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_valid_date_format</span><span class="p">(</span><span class="n">date</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a string adheres to the expected date format &quot;YYYY-MM-DDTHH:MM:SS.sssZ&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        date (str): The string to be validated for the specified date format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the input string adheres to the expected date format, otherwise False.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.odata_to_stac" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">odata_to_stac</span><span class="p">(</span><span class="n">feature_template</span><span class="p">,</span> <span class="n">odata_dict</span><span class="p">,</span> <span class="n">odata_stac_mapper</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>This function is used to map odata values to a given STAC template</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">odata_to_stac</span><span class="p">(</span><span class="n">feature_template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">odata_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">odata_stac_mapper</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function is used to map odata values to a given STAC template&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">feature_template</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid stac feature template&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stac_key</span><span class="p">,</span> <span class="n">eodag_key</span> <span class="ow">in</span> <span class="n">odata_stac_mapper</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">eodag_key</span> <span class="ow">in</span> <span class="n">odata_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stac_key</span> <span class="ow">in</span> <span class="n">feature_template</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]:</span>
                <span class="n">feature_template</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">stac_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">odata_dict</span><span class="p">[</span><span class="n">eodag_key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">stac_key</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                <span class="n">feature_template</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">odata_dict</span><span class="p">[</span><span class="n">eodag_key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">stac_key</span> <span class="o">==</span> <span class="s2">&quot;file:size&quot;</span><span class="p">:</span>
                <span class="n">feature_template</span><span class="p">[</span><span class="s2">&quot;assets&quot;</span><span class="p">][</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="n">stac_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">odata_dict</span><span class="p">[</span><span class="n">eodag_key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">feature_template</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.sort_feature_collection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sort_feature_collection</span><span class="p">(</span><span class="n">feature_collection</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>This function sorts a STAC feature collection based on a given criteria</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sort_feature_collection</span><span class="p">(</span><span class="n">feature_collection</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sortby</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function sorts a STAC feature collection based on a given criteria&quot;&quot;&quot;</span>
    <span class="c1"># Force default sorting even if the input is invalid, don&#39;t block the return collection because of sorting.</span>
    <span class="k">if</span> <span class="n">sortby</span> <span class="o">!=</span> <span class="s2">&quot;+doNotSort&quot;</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">sortby</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_collection</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">feature_collection</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">sortby</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;datetime&quot;</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feature_collection</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">field</span>
            <span class="n">feature_collection</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">feature_collection</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">],</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">feature</span><span class="p">:</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">by</span><span class="p">],</span>
                <span class="n">reverse</span><span class="o">=</span><span class="n">order</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">feature_collection</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.update_db" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">db_product</span><span class="p">,</span> <span class="n">estatus</span><span class="p">,</span> <span class="n">status_fail_message</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Update the download status of a product in the database.</p>
<p>This function attempts to update the download status of a product in the database.
It retries the update operation for a maximum of three times, waiting 1 second between attempts.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>db_product</code></td>
            <td>
                  <code><span title="rs_server_common.db.models.download_status.DownloadStatus">DownloadStatus</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The product whose status needs to be updated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>estatus</code></td>
            <td>
                  <code><span title="rs_server_common.db.models.download_status.EDownloadStatus">EDownloadStatus</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The new download status.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>status_fail_message</code></td>
            <td>
                  <code>Optional[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional message associated with the failure status.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="sqlalchemy.exc.OperationalError">OperationalError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the database update operation fails after multiple attempts.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>update_db(db_session, product_instance, EDownloadStatus.DONE)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>This function is designed to update the download status in the database.</li>
<li>It retries the update operation for a maximum of three times.</li>
<li>If the update fails, an exception is raised, indicating an issue with the database.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_db</span><span class="p">(</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
    <span class="n">db_product</span><span class="p">:</span> <span class="n">DownloadStatus</span><span class="p">,</span>
    <span class="n">estatus</span><span class="p">:</span> <span class="n">EDownloadStatus</span><span class="p">,</span>
    <span class="n">status_fail_message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the download status of a product in the database.</span>

<span class="sd">    This function attempts to update the download status of a product in the database.</span>
<span class="sd">    It retries the update operation for a maximum of three times, waiting 1 second between attempts.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (sqlalchemy.orm.Session): The database session.</span>
<span class="sd">        db_product (DownloadStatus): The product whose status needs to be updated.</span>
<span class="sd">        estatus (EDownloadStatus): The new download status.</span>
<span class="sd">        status_fail_message (Optional[str]): An optional message associated with the failure status.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Raises:</span>
<span class="sd">        sqlalchemy.exc.OperationalError: If the database update operation fails after multiple attempts.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; update_db(db_session, product_instance, EDownloadStatus.DONE)</span>

<span class="sd">    Note:</span>
<span class="sd">        - This function is designed to update the download status in the database.</span>
<span class="sd">        - It retries the update operation for a maximum of three times.</span>
<span class="sd">        - If the update fails, an exception is raised, indicating an issue with the database.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try n times to update the status.</span>
    <span class="c1"># Don&#39;t do it for NOT_STARTED and IN_PROGRESS (call directly db_product.not_started</span>
    <span class="c1"># or db_product.in_progress) because it will anyway be overwritten later by DONE or FAILED.</span>

    <span class="c1"># Init last exception to empty value.</span>
    <span class="n">last_exception</span><span class="p">:</span> <span class="ne">Exception</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">estatus</span> <span class="o">==</span> <span class="n">EDownloadStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                <span class="n">db_product</span><span class="o">.</span><span class="n">failed</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">status_fail_message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">estatus</span> <span class="o">==</span> <span class="n">EDownloadStatus</span><span class="o">.</span><span class="n">DONE</span><span class="p">:</span>
                <span class="n">db_product</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

            <span class="c1"># The database update worked, exit function</span>
            <span class="k">return</span>

        <span class="c1"># The database update failed, wait n seconds and retry</span>
        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating status in database:</span><span class="se">\n</span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">last_exception</span> <span class="o">=</span> <span class="n">exception</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># If all attemps failed, raise the last Exception</span>
    <span class="k">raise</span> <span class="n">last_exception</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.validate_inputs_format" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_inputs_format</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Validate the format of the input time interval.</p>
<p>This function checks whether the input interval has a valid format (start_date/stop_date) and
whether the start and stop dates are in a valid ISO 8601 format.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>-</code></td>
            <td>
                  <code>interval (str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time interval to be validated, with the following format:
"2024-01-01T00:00:00Z/2024-01-02T23:59:59Z"</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="datetime.datetime">datetime</span>, <span title="datetime.datetime">datetime</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[datetime, datetime]:
A tuple containing:
- start_date (datetime): The start date of the interval.
- stop_date (datetime): The stop date of the interval.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>The input interval should be in the format "start_date/stop_date"
(e.g., "2022-01-01T00:00:00Z/2022-01-02T00:00:00Z").</li>
<li>This function checks for missing start/stop and validates the ISO 8601 format of start and stop dates.</li>
<li>If there is an error, err_code and err_text provide information about the issue.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">validate_inputs_format</span><span class="p">(</span><span class="n">interval</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the format of the input time interval.</span>

<span class="sd">    This function checks whether the input interval has a valid format (start_date/stop_date) and</span>
<span class="sd">    whether the start and stop dates are in a valid ISO 8601 format.</span>

<span class="sd">    Args:</span>
<span class="sd">        - interval (str): The time interval to be validated, with the following format:</span>
<span class="sd">            &quot;2024-01-01T00:00:00Z/2024-01-02T23:59:59Z&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[datetime, datetime]:</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - start_date (datetime): The start date of the interval.</span>
<span class="sd">            - stop_date (datetime): The stop date of the interval.</span>

<span class="sd">    Note:</span>
<span class="sd">        - The input interval should be in the format &quot;start_date/stop_date&quot;</span>
<span class="sd">        (e.g., &quot;2022-01-01T00:00:00Z/2022-01-02T00:00:00Z&quot;).</span>
<span class="sd">        - This function checks for missing start/stop and validates the ISO 8601 format of start and stop dates.</span>
<span class="sd">        - If there is an error, err_code and err_text provide information about the issue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">start_date</span><span class="p">,</span> <span class="n">stop_date</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing start or stop in endpoint call!&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_422_UNPROCESSABLE_ENTITY</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Missing start/stop&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_valid_date_format</span><span class="p">(</span><span class="n">start_date</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_valid_date_format</span><span class="p">(</span><span class="n">stop_date</span><span class="p">)):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid start/stop in endpoint call!&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Missing start/stop&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">start_date</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">stop_date</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="rs_server_common.utils.utils.write_search_products_to_db" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_search_products_to_db</span><span class="p">(</span><span class="n">db_handler_class</span><span class="p">,</span> <span class="n">products</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Process a list of products by adding them to the database if not already present.</p>
<p>This function iterates over a list of products. For each product, it checks whether the product
is already registered in the database. If the product is not in the database, it is added with
its relevant details. The function collects a list of product IDs and names for further processing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>-</code></td>
            <td>
                  <code>products (List[Product]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of product objects to be processed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>-</code></td>
            <td>
                  <code>db_handler_class</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database handler class used for database operations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[Tuple]: A list of tuples, each containing the 'id' and 'Name' properties of a product.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>-<span title="sqlalchemy.exc.OperationalError">OperationalError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If there's an issue connecting to the database.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>The function assumes that 'products' is a list of objects with a 'properties' attribute,
  which is a dictionary containing keys 'id', 'Name', and 'startTimeFromAscendingNode'.</li>
<li>'get_db' is a context manager that provides a database session.</li>
<li>'EDownloadStatus' is an enumeration representing download status.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>rs_server_common/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_search_products_to_db</span><span class="p">(</span><span class="n">db_handler_class</span><span class="p">:</span> <span class="n">DownloadStatus</span><span class="p">,</span> <span class="n">products</span><span class="p">:</span> <span class="n">EOProduct</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a list of products by adding them to the database if not already present.</span>

<span class="sd">    This function iterates over a list of products. For each product, it checks whether the product</span>
<span class="sd">    is already registered in the database. If the product is not in the database, it is added with</span>
<span class="sd">    its relevant details. The function collects a list of product IDs and names for further processing.</span>

<span class="sd">    Args:</span>
<span class="sd">        - products (List[Product]): A list of product objects to be processed.</span>
<span class="sd">        - db_handler_class: The database handler class used for database operations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Tuple]: A list of tuples, each containing the &#39;id&#39; and &#39;Name&#39; properties of a product.</span>

<span class="sd">    Raises:</span>
<span class="sd">        - sqlalchemy.exc.OperationalError: If there&#39;s an issue connecting to the database.</span>

<span class="sd">    Note:</span>
<span class="sd">        - The function assumes that &#39;products&#39; is a list of objects with a &#39;properties&#39; attribute,</span>
<span class="sd">          which is a dictionary containing keys &#39;id&#39;, &#39;Name&#39;, and &#39;startTimeFromAscendingNode&#39;.</span>
<span class="sd">        - &#39;get_db&#39; is a context manager that provides a database session.</span>
<span class="sd">        - &#39;EDownloadStatus&#39; is an enumeration representing download status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">contextmanager</span><span class="p">(</span><span class="n">get_db</span><span class="p">)()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db_handler_class</span><span class="o">.</span><span class="n">get_if_exists</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Product </span><span class="si">%s</span><span class="s2"> is already registered in database, skipping&quot;</span><span class="p">,</span>
                        <span class="n">product</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">db_handler_class</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">db</span><span class="p">,</span>
                    <span class="n">product_id</span><span class="o">=</span><span class="n">product</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">product</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">],</span>
                    <span class="n">available_at_station</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;startTimeFromAscendingNode&quot;</span><span class="p">]),</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">EDownloadStatus</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to connect with DB during listing procedure&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="rs_server_common.data_retrieval.eodag_provider"></a>
    <div class="doc doc-contents first">

      <p>EODAG Provider.</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="rs_server_common.data_retrieval.eodag_provider.EodagProvider" class="doc doc-heading">
            <code>EodagProvider</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="rs_server_common.data_retrieval.provider.Provider" href="#rs_server_common.data_retrieval.provider.Provider">Provider</a></code></p>


      <p>An EODAG provider.</p>
<p>It uses EODAG to provide data from external sources.</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/data_retrieval/eodag_provider.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EodagProvider</span><span class="p">(</span><span class="n">Provider</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An EODAG provider.</span>

<span class="sd">    It uses EODAG to provide data from external sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># static Lock instance</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a EODAG provider.</span>

<span class="sd">        Args:</span>
<span class="sd">            config_file: the path to the eodag configuration file</span>
<span class="sd">            provider: the name of the eodag provider</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eodag_cfg_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>  <span class="c1"># pylint: disable=consider-using-with</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="n">config_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span> <span class="n">EODataAccessGateway</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_eodag_client</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">set_preferred_provider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Destructor&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eodag_cfg_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># remove the unique /tmp dir</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">init_eodag_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EODataAccessGateway</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the eodag client.</span>

<span class="sd">        The EODAG client is initialized for the given provider.</span>

<span class="sd">        Args:</span>
<span class="sd">            config_file: the path to the eodag configuration file</span>

<span class="sd">        Returns:</span>
<span class="sd">             the initialized eodag client</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use thread-lock</span>
            <span class="k">with</span> <span class="n">EodagProvider</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;EODAG_CFG_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eodag_cfg_dir</span><span class="o">.</span><span class="n">name</span>
                <span class="k">return</span> <span class="n">EODataAccessGateway</span><span class="p">(</span><span class="n">config_file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CreateProviderFailed</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t initialize </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2"> provider&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">def</span> <span class="nf">_specific_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">between</span><span class="p">:</span> <span class="n">TimeRange</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Conducts a search for products within a specified time range.</span>

<span class="sd">        This private method interfaces with the client&#39;s search functionality,</span>
<span class="sd">        retrieving products that fall within the given time range. The &#39;between&#39;</span>
<span class="sd">        parameter is expected to be a TimeRange object, encompassing start and end</span>
<span class="sd">        timestamps. The method returns a dictionary of products keyed by their</span>
<span class="sd">        respective identifiers.</span>

<span class="sd">        Args:</span>
<span class="sd">            between (TimeRange): An object representing the start and end timestamps</span>
<span class="sd">                                for the search range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SearchResult: A dictionary where keys are product identifiers and</span>
<span class="sd">                            values are EOProduct instances.</span>

<span class="sd">        Note:</span>
<span class="sd">            The time format of the &#39;between&#39; parameter should be verified or formatted</span>
<span class="sd">            appropriately before invoking this method. The method also assumes that the</span>
<span class="sd">            client&#39;s search function is correctly set up to handle the provided time</span>
<span class="sd">            range format.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the search encounters an error or fails, an exception is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapped_search_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sessions_search&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">session_id</span> <span class="o">:=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">mapped_search_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;SessionIds&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_id</span><span class="p">)})</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">mapped_search_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;SessionId&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">platform</span> <span class="o">:=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;platform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">mapped_search_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;platforms&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">platform</span><span class="p">)})</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">mapped_search_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">between</span><span class="p">:</span>
                <span class="n">mapped_search_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;startTimeFromAscendingNode&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">between</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                        <span class="s2">&quot;completionTimeFromAscendingNode&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">between</span><span class="o">.</span><span class="n">end</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">products</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">mapped_search_args</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="n">provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
                    <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">RequestError</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">products</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">between</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                    <span class="n">end</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">between</span><span class="o">.</span><span class="n">end</span><span class="p">),</span>
                    <span class="n">provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
                    <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">RequestError</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">products</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download the expected product at the given local location.</span>

<span class="sd">        EODAG needs an EOProduct to download.</span>
<span class="sd">        We build an EOProduct from the id and download location</span>
<span class="sd">        to be able to call EODAG for download.</span>


<span class="sd">        Args:</span>
<span class="sd">            product_id: the id of the product to download</span>
<span class="sd">            to_file: the path where the product has to be download</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_eodag_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">to_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># download_plugin = self.client._plugins_manager.get_download_plugin(product)</span>
        <span class="c1"># authent_plugin = self.client._plugins_manager.get_auth_plugin(product.provider)</span>
        <span class="c1"># product.register_downloader(download_plugin, authent_plugin)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">outputs_prefix</span><span class="o">=</span><span class="n">to_file</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_eodag_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an EO product with minimal properties.</span>

<span class="sd">        The title is used by EODAG as the name of the downloaded file.</span>
<span class="sd">        The download link is used by EODAG as http request url for download.</span>
<span class="sd">        The geometry is mandatory in an EO Product so we add the all earth as geometry.</span>

<span class="sd">        Args:</span>
<span class="sd">            product_id: the id of EO Product</span>
<span class="sd">            filename: the name of the downloaded file</span>

<span class="sd">        Returns:</span>
<span class="sd">            the initialized EO Product</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">base_uri</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s2">&quot;download&quot;</span><span class="p">][</span><span class="s2">&quot;base_uri&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">EOProduct</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">product_id</span><span class="p">,</span>
                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;POLYGON((180 -90, 180 90, -180 90, -180 -90, 180 -90))&quot;</span><span class="p">,</span>
                    <span class="c1"># TODO build from configuration (but how ?)</span>
                    <span class="s2">&quot;downloadLink&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">)/$value&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CreateProviderFailed</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t initialize </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2"> download provider&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="rs_server_common.data_retrieval.eodag_provider.EodagProvider.__del__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__del__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Destructor</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/data_retrieval/eodag_provider.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Destructor&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eodag_cfg_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># remove the unique /tmp dir</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.data_retrieval.eodag_provider.EodagProvider.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Create a EODAG provider.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>config_file</code></td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the path to the eodag configuration file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>provider</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the name of the eodag provider</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/data_retrieval/eodag_provider.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a EODAG provider.</span>

<span class="sd">    Args:</span>
<span class="sd">        config_file: the path to the eodag configuration file</span>
<span class="sd">        provider: the name of the eodag provider</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eodag_cfg_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>  <span class="c1"># pylint: disable=consider-using-with</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">provider</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="n">config_file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span> <span class="n">EODataAccessGateway</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_eodag_client</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">set_preferred_provider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.data_retrieval.eodag_provider.EodagProvider.create_eodag_product" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_eodag_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Initialize an EO product with minimal properties.</p>
<p>The title is used by EODAG as the name of the downloaded file.
The download link is used by EODAG as http request url for download.
The geometry is mandatory in an EO Product so we add the all earth as geometry.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>product_id</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the id of EO Product</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>filename</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the name of the downloaded file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the initialized EO Product</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/data_retrieval/eodag_provider.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_eodag_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize an EO product with minimal properties.</span>

<span class="sd">    The title is used by EODAG as the name of the downloaded file.</span>
<span class="sd">    The download link is used by EODAG as http request url for download.</span>
<span class="sd">    The geometry is mandatory in an EO Product so we add the all earth as geometry.</span>

<span class="sd">    Args:</span>
<span class="sd">        product_id: the id of EO Product</span>
<span class="sd">        filename: the name of the downloaded file</span>

<span class="sd">    Returns:</span>
<span class="sd">        the initialized EO Product</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">base_uri</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s2">&quot;download&quot;</span><span class="p">][</span><span class="s2">&quot;base_uri&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">EOProduct</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">product_id</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;POLYGON((180 -90, 180 90, -180 90, -180 -90, 180 -90))&quot;</span><span class="p">,</span>
                <span class="c1"># TODO build from configuration (but how ?)</span>
                <span class="s2">&quot;downloadLink&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">)/$value&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CreateProviderFailed</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t initialize </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2"> download provider&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.data_retrieval.eodag_provider.EodagProvider.download" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">to_file</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Download the expected product at the given local location.</p>
<p>EODAG needs an EOProduct to download.
We build an EOProduct from the id and download location
to be able to call EODAG for download.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>product_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the id of the product to download</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>to_file</code></td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the path where the product has to be download</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/data_retrieval/eodag_provider.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the expected product at the given local location.</span>

<span class="sd">    EODAG needs an EOProduct to download.</span>
<span class="sd">    We build an EOProduct from the id and download location</span>
<span class="sd">    to be able to call EODAG for download.</span>


<span class="sd">    Args:</span>
<span class="sd">        product_id: the id of the product to download</span>
<span class="sd">        to_file: the path where the product has to be download</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_eodag_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">to_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># download_plugin = self.client._plugins_manager.get_download_plugin(product)</span>
    <span class="c1"># authent_plugin = self.client._plugins_manager.get_auth_plugin(product.provider)</span>
    <span class="c1"># product.register_downloader(download_plugin, authent_plugin)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">outputs_prefix</span><span class="o">=</span><span class="n">to_file</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.data_retrieval.eodag_provider.EodagProvider.init_eodag_client" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">init_eodag_client</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Initialize the eodag client.</p>
<p>The EODAG client is initialized for the given provider.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>config_file</code></td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the path to the eodag configuration file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="eodag.EODataAccessGateway">EODataAccessGateway</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the initialized eodag client</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/data_retrieval/eodag_provider.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">init_eodag_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EODataAccessGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the eodag client.</span>

<span class="sd">    The EODAG client is initialized for the given provider.</span>

<span class="sd">    Args:</span>
<span class="sd">        config_file: the path to the eodag configuration file</span>

<span class="sd">    Returns:</span>
<span class="sd">         the initialized eodag client</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use thread-lock</span>
        <span class="k">with</span> <span class="n">EodagProvider</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;EODAG_CFG_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eodag_cfg_dir</span><span class="o">.</span><span class="n">name</span>
            <span class="k">return</span> <span class="n">EODataAccessGateway</span><span class="p">(</span><span class="n">config_file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CreateProviderFailed</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t initialize </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2"> provider&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="rs_server_common.data_retrieval.provider"></a>
    <div class="doc doc-contents first">

      <p>Provider mechanism.</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="rs_server_common.data_retrieval.provider.CreateProviderFailed" class="doc doc-heading">
            <code>CreateProviderFailed</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>Exception</code></p>


      <p>Exception raised when an error occurred during the init of a provider.</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CreateProviderFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when an error occurred during the init of a provider.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.data_retrieval.provider.DownloadProductFailed" class="doc doc-heading">
            <code>DownloadProductFailed</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>Exception</code></p>


      <p>Exception raised when an error occurred during the download.</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DownloadProductFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when an error occurred during the download.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.data_retrieval.provider.Product" class="doc doc-heading">
            <code>Product</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>A product.</p>
<p>A product has an external identifier and a dictionary of metadata.</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A product.</span>

<span class="sd">    A product has an external identifier and a dictionary of metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">id_</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.data_retrieval.provider.Provider" class="doc doc-heading">
            <code>Provider</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


      <p>A product provider.</p>
<p>A provider gives a common interface to search for files from an external data source
and download them locally.</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Provider</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A product provider.</span>

<span class="sd">    A provider gives a common interface to search for files from an external data source</span>
<span class="sd">    and download them locally.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">between</span><span class="p">:</span> <span class="n">TimeRange</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search for products with the given time range.</span>

<span class="sd">        The search result is a dictionary of products found indexed by id.</span>

<span class="sd">        Args:</span>
<span class="sd">            between: the search period</span>

<span class="sd">        Returns:</span>
<span class="sd">            The files found indexed by file id. Specific to each provider.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">between</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">between</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">between</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SearchProductFailed</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search timerange is inverted : (</span><span class="si">{</span><span class="n">between</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">between</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specific_search</span><span class="p">(</span><span class="n">between</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_specific_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">between</span><span class="p">:</span> <span class="n">TimeRange</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search for products with the given time range.</span>

<span class="sd">        Specific search for products after common verification.</span>

<span class="sd">        Args:</span>
<span class="sd">            between: the search period</span>

<span class="sd">        Returns:</span>
<span class="sd">            the files found indexed by file id.</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download the given product to the given local path.</span>

<span class="sd">        Args:</span>
<span class="sd">            product_id: id of the product to download</span>
<span class="sd">            to_file: path where the file should be downloaded</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="rs_server_common.data_retrieval.provider.Provider.download" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">to_file</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Download the given product to the given local path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>product_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>id of the product to download</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>to_file</code></td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path where the file should be downloaded</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the given product to the given local path.</span>

<span class="sd">    Args:</span>
<span class="sd">        product_id: id of the product to download</span>
<span class="sd">        to_file: path where the file should be downloaded</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.data_retrieval.provider.Provider.search" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">search</span><span class="p">(</span><span class="n">between</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Search for products with the given time range.</p>
<p>The search result is a dictionary of products found indexed by id.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>between</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="rs_server_common.data_retrieval.provider.TimeRange" href="#rs_server_common.data_retrieval.provider.TimeRange">TimeRange</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the search period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The files found indexed by file id. Specific to each provider.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">between</span><span class="p">:</span> <span class="n">TimeRange</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for products with the given time range.</span>

<span class="sd">    The search result is a dictionary of products found indexed by id.</span>

<span class="sd">    Args:</span>
<span class="sd">        between: the search period</span>

<span class="sd">    Returns:</span>
<span class="sd">        The files found indexed by file id. Specific to each provider.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">between</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">between</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">between</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SearchProductFailed</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search timerange is inverted : (</span><span class="si">{</span><span class="n">between</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">between</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specific_search</span><span class="p">(</span><span class="n">between</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.data_retrieval.provider.SearchProductFailed" class="doc doc-heading">
            <code>SearchProductFailed</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>Exception</code></p>


      <p>Exception raised when an error occurred during the search.</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SearchProductFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when an error occurred during the search.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.data_retrieval.provider.TimeRange" class="doc doc-heading">
            <code>TimeRange</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>A time range.</p>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TimeRange</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A time range.&quot;&quot;&quot;</span>

    <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span>

    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Duration of the timerange.</span>

<span class="sd">        Returns: duration of the timerange</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="rs_server_common.data_retrieval.provider.TimeRange.duration" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">duration</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Duration of the timerange.</p>
<p>Returns: duration of the timerange</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/data_retrieval/provider.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Duration of the timerange.</span>

<span class="sd">    Returns: duration of the timerange</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="rs_server_common.s3_storage_handler.s3_storage_handler"></a>
    <div class="doc doc-contents first">

      <p>TODO Docstring to be added.</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config" class="doc doc-heading">
            <code>GetKeysFromS3Config</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>S3 configuration for download</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config.s3_files">s3_files</span></code></td>
            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list with the  S3 object keys to be downloaded.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config.bucket">bucket</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 bucket name.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config.local_prefix">local_prefix</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The local prefix where files will be downloaded.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config.overwrite">overwrite</span></code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Flag indicating whether to overwrite existing files. Default is False.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config.max_retries">max_retries</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of download retries. Default is DWN_S3FILE_RETRIES.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">GetKeysFromS3Config</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;S3 configuration for download</span>

<span class="sd">    Attributes:</span>
<span class="sd">        s3_files (list): A list with the  S3 object keys to be downloaded.</span>
<span class="sd">        bucket (str): The S3 bucket name.</span>
<span class="sd">        local_prefix (str): The local prefix where files will be downloaded.</span>
<span class="sd">        overwrite (bool, optional): Flag indicating whether to overwrite existing files. Default is False.</span>
<span class="sd">        max_retries (int, optional): The maximum number of download retries. Default is DWN_S3FILE_RETRIES.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">s3_files</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">local_prefix</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DWN_S3FILE_RETRIES</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config" class="doc doc-heading">
            <code>PutFilesToS3Config</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>Configuration for uploading files to S3.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config.files">files</span></code></td>
            <td>
                  <code><span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list with the local file paths to be uploaded.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config.bucket">bucket</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 bucket name.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config.s3_path">s3_path</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 path where files will be uploaded.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config.max_retries">max_retries</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of upload retries. Default is UP_S3FILE_RETRIES.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PutFilesToS3Config</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for uploading files to S3.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        files (List): A list with the local file paths to be uploaded.</span>
<span class="sd">        bucket (str): The S3 bucket name.</span>
<span class="sd">        s3_path (str): The S3 path where files will be uploaded.</span>
<span class="sd">        max_retries (int, optional): The maximum number of upload retries. Default is UP_S3FILE_RETRIES.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">files</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">s3_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">UP_S3FILE_RETRIES</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler" class="doc doc-heading">
            <code>S3StorageHandler</code>


</h2>


    <div class="doc doc-contents ">


      <p>Interacts with an S3 storage</p>
<p>S3StorageHandler for interacting with an S3 storage service.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.access_key_id">access_key_id</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The access key ID for S3 authentication.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.secret_access_key">secret_access_key</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The secret access key for S3 authentication.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.endpoint_url">endpoint_url</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The endpoint URL for the S3 service.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.region_name">region_name</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The region name.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.s3_client">s3_client</span></code></td>
            <td>
                  <code><span title="boto3.client">client</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The s3 client to interact with the s3 storage</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">S3StorageHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interacts with an S3 storage</span>

<span class="sd">    S3StorageHandler for interacting with an S3 storage service.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        access_key_id (str): The access key ID for S3 authentication.</span>
<span class="sd">        secret_access_key (str): The secret access key for S3 authentication.</span>
<span class="sd">        endpoint_url (str): The endpoint URL for the S3 service.</span>
<span class="sd">        region_name (str): The region name.</span>
<span class="sd">        s3_client (boto3.client): The s3 client to interact with the s3 storage</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_key_id</span><span class="p">,</span> <span class="n">secret_access_key</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="n">region_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the S3StorageHandler instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            access_key_id (str): The access key ID for S3 authentication.</span>
<span class="sd">            secret_access_key (str): The secret access key for S3 authentication.</span>
<span class="sd">            endpoint_url (str): The endpoint URL for the S3 service.</span>
<span class="sd">            region_name (str): The region name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the connection to the S3 storage cannot be established.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logging</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">access_key_id</span> <span class="o">=</span> <span class="n">access_key_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_access_key</span> <span class="o">=</span> <span class="n">secret_access_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span> <span class="o">=</span> <span class="n">endpoint_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span> <span class="o">=</span> <span class="n">region_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S3StorageHandler created !&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_s3_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_key_id</span><span class="p">,</span> <span class="n">secret_access_key</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="n">region_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve or create an S3 client instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            access_key_id (str): The access key ID for S3 authentication.</span>
<span class="sd">            secret_access_key (str): The secret access key for S3 authentication.</span>
<span class="sd">            endpoint_url (str): The endpoint URL for the S3 service.</span>
<span class="sd">            region_name (str): The region name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            boto3.client: An S3 client instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">client_config</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span>
            <span class="n">max_pool_connections</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="c1"># timeout for connection</span>
            <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="c1"># attempts in trying connection</span>
            <span class="c1"># note:  the default behaviour of boto3 is retrying</span>
            <span class="c1"># connections multiple times and exponentially backing off in between</span>
            <span class="n">retries</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;total_max_attempts&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
                <span class="s2">&quot;s3&quot;</span><span class="p">,</span>
                <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">access_key_id</span><span class="p">,</span>
                <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">secret_access_key</span><span class="p">,</span>
                <span class="n">endpoint_url</span><span class="o">=</span><span class="n">endpoint_url</span><span class="p">,</span>
                <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">client_config</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client error exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Client error exception &quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">def</span> <span class="nf">connect_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish a connection to the S3 service.</span>

<span class="sd">        If the S3 client is not already instantiated, this method calls the private __get_s3_client</span>
<span class="sd">        method to create an S3 client instance using the provided credentials and configuration (see __init__).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_s3_client</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_key_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secret_access_key</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">disconnect_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the connection to the S3 service.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">delete_file_from_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">s3_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a file from S3.</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket (str): The S3 bucket name.</span>
<span class="sd">            s3_obj (str): The S3 object key.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If an error occurs during the bucket access check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s3_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input error for deleting the file&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Delete key s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">s3_obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">s3_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete key s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s3_obj</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete key s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s3_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete key s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s3_obj</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete key s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s3_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="c1"># helper functions</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_secrets_from_file</span><span class="p">(</span><span class="n">secrets</span><span class="p">,</span> <span class="n">secret_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read secrets from a specified file.</span>

<span class="sd">        It reads the secrets from .s3cfg or aws credentials files</span>
<span class="sd">        This function should not be used in production</span>

<span class="sd">        Args:</span>
<span class="sd">            secrets (dict): Dictionary to store retrieved secrets.</span>
<span class="sd">            secret_file (str): Path to the file containing secrets.</span>
<span class="sd">            logger (Logger, optional): Logger instance for error logging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dict_filled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">secret_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">aws_credentials_file</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">aws_credentials_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;s3endpoint&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;host_bucket&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">dict_filled</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;s3endpoint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;accesskey&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;access_key&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">dict_filled</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;accesskey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;secretkey&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;secret_&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">&quot;_key&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">dict_filled</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;secretkey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dict_filled</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the filename from a full path.</span>

<span class="sd">        Args:</span>
<span class="sd">            int_path (str): The full path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">ntpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span> <span class="ow">or</span> <span class="n">ntpath</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">s3_path_parser</span><span class="p">(</span><span class="n">s3_url</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses S3 URL to extract bucket, prefix, and file.</span>

<span class="sd">        Args:</span>
<span class="sd">            s3_url (str): The S3 URL.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Tuple containing bucket, prefix, and file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s3_data</span> <span class="o">=</span> <span class="n">s3_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">s3_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">):</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_data</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s3_data</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">s3_file</span> <span class="o">=</span> <span class="n">s3_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">s3_file</span>

    <span class="k">def</span> <span class="nf">files_to_be_downloaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a list with the S3 keys to be downloaded.</span>

<span class="sd">        The list will have the s3 keys to be downloaded from the bucket.</span>
<span class="sd">        It contains pairs (local_prefix_where_the_file_will_be_downloaded, full_s3_key_path)</span>
<span class="sd">        If a s3 key doesn&#39;t exist, the pair will be (None, requested_s3_key_path)</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket (str): The S3 bucket name.</span>
<span class="sd">            paths (list): List of S3 object keys.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of tuples (local_prefix, full_s3_key_path).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># declaration of the list</span>
        <span class="n">list_with_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># for each key, identify it as a file or a folder</span>
        <span class="c1"># in the case of a folder, the files will be recursively gathered</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">s3_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_s3_files_obj</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No key </span><span class="si">%s</span><span class="s2"> found.&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;total: </span><span class="si">%s</span><span class="s2"> | s3_files = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_files</span><span class="p">),</span> <span class="n">s3_files</span><span class="p">)</span>
            <span class="n">basename_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="c1"># check if it&#39;s a file or a dir</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="n">s3_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># the current key is a file, append it to the list</span>
                <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s3_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Append files: list_with_files = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">list_with_files</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># the current key is a folder, append all its files (reursively gathered) to the list</span>
                <span class="k">for</span> <span class="n">s3_file</span> <span class="ow">in</span> <span class="n">s3_files</span><span class="p">:</span>
                    <span class="n">split</span> <span class="o">=</span> <span class="n">s3_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                    <span class="n">split_idx</span> <span class="o">=</span> <span class="n">split</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">basename_part</span><span class="p">)</span>
                    <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">split</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">s3_file</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">list_with_files</span>

    <span class="k">def</span> <span class="nf">files_to_be_uploaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a list with the local files to be uploaded.</span>

<span class="sd">        The list contains pairs (s3_path, absolute_local_file_path)</span>
<span class="sd">        If the local file doesn&#39;t exist, the pair will be (None, requested_file_to_upload)</span>

<span class="sd">        Args:</span>
<span class="sd">            paths (list): List of local file paths.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of tuples (s3_path, absolute_local_file_path).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">list_with_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">local</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># check if it is a file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;path = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Add </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dir_names</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                        <span class="n">full_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;full_file_path = </span><span class="si">%s</span><span class="s2"> | dir_names = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">,</span> <span class="n">dir_names</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;get_basename(path) = </span><span class="si">%s</span><span class="s2"> | root = </span><span class="si">%s</span><span class="s2"> | replace = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                            <span class="n">root</span><span class="p">,</span>
                            <span class="n">root</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="p">)</span>

                        <span class="n">keep_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">root</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;path = </span><span class="si">%s</span><span class="s2"> | keep_path = </span><span class="si">%s</span><span class="s2"> | root = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">keep_path</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Add: </span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">keep_path</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">)</span>
                        <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">keep_path</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The path </span><span class="si">%s</span><span class="s2"> is not a directory nor a file, it will not be uploaded&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">list_with_files</span>

    <span class="k">def</span> <span class="nf">list_s3_files_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the content of an S3 directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket (str): The S3 bucket name.</span>
<span class="sd">            prefix (str): The S3 object key prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List containing S3 object keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s3_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">paginator</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects_v2&quot;</span><span class="p">)</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Contents&quot;</span><span class="p">,</span> <span class="p">()):</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">s3_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception when trying to list files from s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listing files from s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>

        <span class="k">return</span> <span class="n">s3_files</span>

    <span class="k">def</span> <span class="nf">check_bucket_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the accessibility of an S3 bucket.</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket (str): The S3 bucket name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If an error occurs during the bucket access check.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">head_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="c1"># check that it was a 404 vs 403 errors</span>
            <span class="c1"># If it was a 404 error, then the bucket does not exist.</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="n">S3_ERR_FORBIDDEN_ACCESS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> is a private bucket. Forbidden access!&quot;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> is a private bucket. Forbidden access!&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
            <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="n">S3_ERR_NOT_FOUND</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> bucket does not exist!&quot;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> bucket does not exist!&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception when checking the access to </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> bucket: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception when checking the access to </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> bucket&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EndpointConnectionError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not connect to the endpoint when trying to access </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not connect to the endpoint when trying to access </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;General exception when trying to access bucket </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;General exception when trying to access bucket </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>

    <span class="k">def</span> <span class="nf">wait_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for a specified timeout duration (minimum 200 ms).</span>

<span class="sd">        This function implements a simple timeout mechanism, where it sleeps for 0.2 seconds</span>
<span class="sd">        in each iteration until the cumulative sleep time reaches the specified timeout duration.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout (float): The total duration to wait in seconds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_cnt</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="n">time_cnt</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SLEEP_TIME</span><span class="p">)</span>
            <span class="n">time_cnt</span> <span class="o">+=</span> <span class="n">SLEEP_TIME</span>

    <span class="k">def</span> <span class="nf">check_file_overwriting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if file exists and determine if it should be overwritten.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_file (str): Path to the local file.</span>
<span class="sd">            overwrite (bool): Whether to overwrite the existing file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the file should be overwritten, False otherwise.</span>

<span class="sd">        Note:</span>
<span class="sd">        - If the file already exists and the overwrite flag is set to True, the function logs a message,</span>
<span class="sd">        deletes the existing file, and returns True.</span>
<span class="sd">        - If the file already exists and the overwrite flag is set to False, the function logs a warning</span>
<span class="sd">        message, and returns False. In this case, the existing file won&#39;t be deleted.</span>
<span class="sd">        - If the file doesn&#39;t exist, the function returns True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>  <span class="c1"># The file already exists, so delete it first</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> already exists. Deleting it before downloading&quot;</span><span class="p">,</span>
                    <span class="n">S3StorageHandler</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">local_file</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> already exists. Ignoring (use the overwrite flag if you want to overwrite this file)&quot;</span><span class="p">,</span>
                    <span class="n">S3StorageHandler</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">local_file</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_keys_from_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">GetKeysFromS3Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download S3 keys specified in the configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (GetKeysFromS3Config): Configuration for the S3 download.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: A list with the S3 keys that couldn&#39;t be downloaded.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Any unexpected exception raised during the download process.</span>

<span class="sd">        The function attempts to download files from S3 according to the provided configuration.</span>
<span class="sd">        It returns a list of S3 keys that couldn&#39;t be downloaded successfully.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check the access to the bucket first, or even if it does exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>

        <span class="c1"># collection_files: list of files to be downloaded</span>
        <span class="c1">#                   the list contains pair objects with the following</span>
        <span class="c1">#                   syntax: (local_path_to_be_added_to_the_local_prefix, s3_key)</span>
        <span class="c1">#                   the local_path_to_be_added_to_the_local_prefix may be none if the file doesn&#39;t exist</span>
        <span class="n">collection_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_be_downloaded</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">s3_files</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;collection_files = </span><span class="si">%s</span><span class="s2"> | bucket = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">collection_files</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
        <span class="n">failed_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">collection_file</span> <span class="ow">in</span> <span class="n">collection_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">local_prefix</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
            <span class="n">s3_file</span> <span class="o">=</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># for each file to download, create the local dir (if it does not exist)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># create the path for local file</span>
            <span class="n">local_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">s3_file</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_file_overwriting</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">overwrite</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># download the files</span>
            <span class="n">downloaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">keep_trying</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
                    <span class="n">dwn_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">s3_file</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> downloaded to </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> ms&quot;</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                        <span class="n">s3_file</span><span class="p">,</span>
                        <span class="n">local_file</span><span class="p">,</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">dwn_start</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">downloaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EndpointConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when downloading the file </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Exception: </span><span class="si">%s</span><span class="s2">. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">s3_file</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">,</span>
                        <span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_s3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when downloading the file </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Couldn&#39;t get the s3 client. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">s3_file</span><span class="p">,</span>
                        <span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">downloaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Could not download the file </span><span class="si">%s</span><span class="s2">. The download was </span><span class="se">\</span>
<span class="s2">retried for </span><span class="si">%s</span><span class="s2"> times. Aborting&quot;</span><span class="p">,</span>
                    <span class="n">s3_file</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s3_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">failed_files</span>

    <span class="k">def</span> <span class="nf">put_files_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PutFilesToS3Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload files to S3 according to the provided configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (PutFilesToS3Config): Configuration for the S3 upload.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: A list with the local file paths that couldn&#39;t be uploaded.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Any unexpected exception raised during the upload process.</span>

<span class="sd">        The function attempts to upload files to S3 according to the provided configuration.</span>
<span class="sd">        It returns a list of local files that couldn&#39;t be uploaded successfully.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check the access to the bucket first, or even if it does exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>

        <span class="n">collection_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_be_uploaded</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="n">failed_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">collection_file</span> <span class="ow">in</span> <span class="n">collection_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The file </span><span class="si">%s</span><span class="s2"> can&#39;t be uploaded, its s3 prefix is None&quot;</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">file_to_be_uploaded</span> <span class="o">=</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># create the s3 key</span>
            <span class="n">s3_obj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">s3_path</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_to_be_uploaded</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
            <span class="n">uploaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">keep_trying</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># get the s3 client</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Upload file </span><span class="si">%s</span><span class="s2"> to s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">file_to_be_uploaded</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                        <span class="n">s3_obj</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">file_to_be_uploaded</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">s3_obj</span><span class="p">)</span>
                    <span class="n">uploaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span>
                    <span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span><span class="p">,</span>
                    <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EndpointConnectionError</span><span class="p">,</span>
                    <span class="n">boto3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">S3UploadFailedError</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when uploading the file </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Exception: </span><span class="si">%s</span><span class="s2">. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">file_to_be_uploaded</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">,</span>
                        <span class="n">UP_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_s3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">UP_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when uploading the file </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Couldn&#39;t get the s3 client. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">file_to_be_uploaded</span><span class="p">,</span>
                        <span class="n">UP_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">UP_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">uploaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Could not upload the file </span><span class="si">%s</span><span class="s2">. The upload was </span><span class="se">\</span>
<span class="s2">retried for </span><span class="si">%s</span><span class="s2"> times. Aborting&quot;</span><span class="p">,</span>
                    <span class="n">file_to_be_uploaded</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_to_be_uploaded</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">failed_files</span>

    <span class="k">def</span> <span class="nf">transfer_from_s3_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">TransferFromS3ToS3Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy S3 keys specified in the configuration.</span>
<span class="sd">        Args:</span>
<span class="sd">            config (TransferFromS3ToS3Config): Configuration object containing bucket source, bucket destination,</span>
<span class="sd">                      S3 files, maximum retries.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of S3 keys that failed to be copied.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Any unexpected exception raised during the upload process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the access to both buckets first, or even if they do exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">)</span>

        <span class="c1"># collection_files: list of files to be downloaded</span>
        <span class="c1">#                   the list contains pair objects with the following</span>
        <span class="c1">#                   syntax: (local_path_to_be_added_to_the_local_prefix, s3_key)</span>

        <span class="n">collection_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_be_downloaded</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">s3_files</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;collection_files = </span><span class="si">%s</span><span class="s2"> | bucket = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">collection_files</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">)</span>
        <span class="n">failed_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_src</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span> <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">collection_file</span> <span class="ow">in</span> <span class="n">collection_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">copied</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">keep_trying</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;keep_trying </span><span class="si">%s</span><span class="s2"> | range(config.max_retries) </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span>
                    <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
                    <span class="n">dwn_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">copy_src</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;copy_src = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">copy_src</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">copy_object</span><span class="p">(</span><span class="n">CopySource</span><span class="o">=</span><span class="n">copy_src</span><span class="p">,</span> <span class="n">Bucket</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> copied to s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> ms&quot;</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span>
                        <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span>
                        <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">dwn_start</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">copy_only</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">delete_file_from_s3</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Key deleted s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">copied</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EndpointConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when copying the file s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> to s3://</span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Exception: </span><span class="si">%s</span><span class="s2">. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span>
                        <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">,</span>
                        <span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_s3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when copying the file s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> to s3://</span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Couldn&#39;t get the s3 client. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span>
                        <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span>
                        <span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">copied</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Could not copy the file s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> to s3://</span><span class="si">%s</span><span class="s2">. The copy was </span><span class="se">\</span>
<span class="s2">retried for </span><span class="si">%s</span><span class="s2"> times. Aborting&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span>
                    <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">failed_files</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.__get_s3_client" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__get_s3_client</span><span class="p">(</span><span class="n">access_key_id</span><span class="p">,</span> <span class="n">secret_access_key</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Retrieve or create an S3 client instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>access_key_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The access key ID for S3 authentication.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>secret_access_key</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The secret access key for S3 authentication.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>endpoint_url</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The endpoint URL for the S3 service.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>region_name</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The region name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>boto3.client: An S3 client instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">__get_s3_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_key_id</span><span class="p">,</span> <span class="n">secret_access_key</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="n">region_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve or create an S3 client instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        access_key_id (str): The access key ID for S3 authentication.</span>
<span class="sd">        secret_access_key (str): The secret access key for S3 authentication.</span>
<span class="sd">        endpoint_url (str): The endpoint URL for the S3 service.</span>
<span class="sd">        region_name (str): The region name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        boto3.client: An S3 client instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">client_config</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span>
        <span class="n">max_pool_connections</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="c1"># timeout for connection</span>
        <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="c1"># attempts in trying connection</span>
        <span class="c1"># note:  the default behaviour of boto3 is retrying</span>
        <span class="c1"># connections multiple times and exponentially backing off in between</span>
        <span class="n">retries</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;total_max_attempts&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s2">&quot;s3&quot;</span><span class="p">,</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">access_key_id</span><span class="p">,</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">secret_access_key</span><span class="p">,</span>
            <span class="n">endpoint_url</span><span class="o">=</span><span class="n">endpoint_url</span><span class="p">,</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">client_config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client error exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Client error exception &quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">access_key_id</span><span class="p">,</span> <span class="n">secret_access_key</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Initialize the S3StorageHandler instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>access_key_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The access key ID for S3 authentication.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>secret_access_key</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The secret access key for S3 authentication.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>endpoint_url</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The endpoint URL for the S3 service.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>region_name</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The region name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>RuntimeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the connection to the S3 storage cannot be established.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_key_id</span><span class="p">,</span> <span class="n">secret_access_key</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="n">region_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the S3StorageHandler instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        access_key_id (str): The access key ID for S3 authentication.</span>
<span class="sd">        secret_access_key (str): The secret access key for S3 authentication.</span>
<span class="sd">        endpoint_url (str): The endpoint URL for the S3 service.</span>
<span class="sd">        region_name (str): The region name.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If the connection to the S3 storage cannot be established.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logging</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">access_key_id</span> <span class="o">=</span> <span class="n">access_key_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">secret_access_key</span> <span class="o">=</span> <span class="n">secret_access_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span> <span class="o">=</span> <span class="n">endpoint_url</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span> <span class="o">=</span> <span class="n">region_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S3StorageHandler created !&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.check_bucket_access" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Check the accessibility of an S3 bucket.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>bucket</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 bucket name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>RuntimeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an error occurs during the bucket access check.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">check_bucket_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the accessibility of an S3 bucket.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str): The S3 bucket name.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If an error occurs during the bucket access check.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">head_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="c1"># check that it was a 404 vs 403 errors</span>
        <span class="c1"># If it was a 404 error, then the bucket does not exist.</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="n">S3_ERR_FORBIDDEN_ACCESS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> is a private bucket. Forbidden access!&quot;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> is a private bucket. Forbidden access!&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
        <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="n">S3_ERR_NOT_FOUND</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> bucket does not exist!&quot;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> bucket does not exist!&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception when checking the access to </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> bucket: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception when checking the access to </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2"> bucket&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EndpointConnectionError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not connect to the endpoint when trying to access </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not connect to the endpoint when trying to access </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;General exception when trying to access bucket </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;General exception when trying to access bucket </span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.check_file_overwriting" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_file_overwriting</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Check if file exists and determine if it should be overwritten.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>local_file</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the local file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>overwrite</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to overwrite the existing file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the file should be overwritten, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
      <p>Note:
- If the file already exists and the overwrite flag is set to True, the function logs a message,
deletes the existing file, and returns True.
- If the file already exists and the overwrite flag is set to False, the function logs a warning
message, and returns False. In this case, the existing file won't be deleted.
- If the file doesn't exist, the function returns True.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">check_file_overwriting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if file exists and determine if it should be overwritten.</span>

<span class="sd">    Args:</span>
<span class="sd">        local_file (str): Path to the local file.</span>
<span class="sd">        overwrite (bool): Whether to overwrite the existing file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the file should be overwritten, False otherwise.</span>

<span class="sd">    Note:</span>
<span class="sd">    - If the file already exists and the overwrite flag is set to True, the function logs a message,</span>
<span class="sd">    deletes the existing file, and returns True.</span>
<span class="sd">    - If the file already exists and the overwrite flag is set to False, the function logs a warning</span>
<span class="sd">    message, and returns False. In this case, the existing file won&#39;t be deleted.</span>
<span class="sd">    - If the file doesn&#39;t exist, the function returns True.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>  <span class="c1"># The file already exists, so delete it first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> already exists. Deleting it before downloading&quot;</span><span class="p">,</span>
                <span class="n">S3StorageHandler</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">local_file</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> already exists. Ignoring (use the overwrite flag if you want to overwrite this file)&quot;</span><span class="p">,</span>
                <span class="n">S3StorageHandler</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">local_file</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.connect_s3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect_s3</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Establish a connection to the S3 service.</p>
<p>If the S3 client is not already instantiated, this method calls the private <strong>get_s3_client
method to create an S3 client instance using the provided credentials and configuration (see __init</strong>).</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">connect_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Establish a connection to the S3 service.</span>

<span class="sd">    If the S3 client is not already instantiated, this method calls the private __get_s3_client</span>
<span class="sd">    method to create an S3 client instance using the provided credentials and configuration (see __init__).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_s3_client</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_key_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secret_access_key</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.delete_file_from_s3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_file_from_s3</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">s3_obj</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Delete a file from S3.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>bucket</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 bucket name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>s3_obj</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 object key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>RuntimeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an error occurs during the bucket access check.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delete_file_from_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">s3_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a file from S3.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str): The S3 bucket name.</span>
<span class="sd">        s3_obj (str): The S3 object key.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If an error occurs during the bucket access check.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s3_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input error for deleting the file&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Delete key s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">s3_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">s3_obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete key s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s3_obj</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete key s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s3_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete key s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s3_obj</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete key s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s3_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.disconnect_s3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">disconnect_s3</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Close the connection to the S3 service.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">disconnect_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close the connection to the S3 service.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.files_to_be_downloaded" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">files_to_be_downloaded</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">paths</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Create a list with the S3 keys to be downloaded.</p>
<p>The list will have the s3 keys to be downloaded from the bucket.
It contains pairs (local_prefix_where_the_file_will_be_downloaded, full_s3_key_path)
If a s3 key doesn't exist, the pair will be (None, requested_s3_key_path)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>bucket</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 bucket name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>paths</code></td>
            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of S3 object keys.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tuples (local_prefix, full_s3_key_path).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">files_to_be_downloaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a list with the S3 keys to be downloaded.</span>

<span class="sd">    The list will have the s3 keys to be downloaded from the bucket.</span>
<span class="sd">    It contains pairs (local_prefix_where_the_file_will_be_downloaded, full_s3_key_path)</span>
<span class="sd">    If a s3 key doesn&#39;t exist, the pair will be (None, requested_s3_key_path)</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str): The S3 bucket name.</span>
<span class="sd">        paths (list): List of S3 object keys.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of tuples (local_prefix, full_s3_key_path).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># declaration of the list</span>
    <span class="n">list_with_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># for each key, identify it as a file or a folder</span>
    <span class="c1"># in the case of a folder, the files will be recursively gathered</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">s3_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_s3_files_obj</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No key </span><span class="si">%s</span><span class="s2"> found.&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;total: </span><span class="si">%s</span><span class="s2"> | s3_files = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_files</span><span class="p">),</span> <span class="n">s3_files</span><span class="p">)</span>
        <span class="n">basename_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># check if it&#39;s a file or a dir</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="n">s3_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># the current key is a file, append it to the list</span>
            <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s3_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Append files: list_with_files = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">list_with_files</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># the current key is a folder, append all its files (reursively gathered) to the list</span>
            <span class="k">for</span> <span class="n">s3_file</span> <span class="ow">in</span> <span class="n">s3_files</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">s3_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">split_idx</span> <span class="o">=</span> <span class="n">split</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">basename_part</span><span class="p">)</span>
                <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">split</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">s3_file</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">list_with_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.files_to_be_uploaded" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">files_to_be_uploaded</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Creates a list with the local files to be uploaded.</p>
<p>The list contains pairs (s3_path, absolute_local_file_path)
If the local file doesn't exist, the pair will be (None, requested_file_to_upload)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>paths</code></td>
            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of local file paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tuples (s3_path, absolute_local_file_path).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">files_to_be_uploaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a list with the local files to be uploaded.</span>

<span class="sd">    The list contains pairs (s3_path, absolute_local_file_path)</span>
<span class="sd">    If the local file doesn&#39;t exist, the pair will be (None, requested_file_to_upload)</span>

<span class="sd">    Args:</span>
<span class="sd">        paths (list): List of local file paths.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of tuples (s3_path, absolute_local_file_path).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">list_with_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">local</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># check if it is a file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;path = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Add </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dir_names</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">full_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;full_file_path = </span><span class="si">%s</span><span class="s2"> | dir_names = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">,</span> <span class="n">dir_names</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;get_basename(path) = </span><span class="si">%s</span><span class="s2"> | root = </span><span class="si">%s</span><span class="s2"> | replace = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                        <span class="n">root</span><span class="p">,</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="n">keep_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">root</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;path = </span><span class="si">%s</span><span class="s2"> | keep_path = </span><span class="si">%s</span><span class="s2"> | root = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">keep_path</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Add: </span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">keep_path</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">)</span>
                    <span class="n">list_with_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">keep_path</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The path </span><span class="si">%s</span><span class="s2"> is not a directory nor a file, it will not be uploaded&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">list_with_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_basename" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Get the filename from a full path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>int_path</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The full path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The filename.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the filename from a full path.</span>

<span class="sd">    Args:</span>
<span class="sd">        int_path (str): The full path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The filename.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">ntpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span> <span class="ow">or</span> <span class="n">ntpath</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_keys_from_s3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_keys_from_s3</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Download S3 keys specified in the configuration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>config</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config" href="#rs_server_common.s3_storage_handler.s3_storage_handler.GetKeysFromS3Config">GetKeysFromS3Config</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for the S3 download.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str]: A list with the S3 keys that couldn't be downloaded.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>Exception</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Any unexpected exception raised during the download process.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
      <p>The function attempts to download files from S3 according to the provided configuration.
It returns a list of S3 keys that couldn't be downloaded successfully.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_keys_from_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">GetKeysFromS3Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download S3 keys specified in the configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (GetKeysFromS3Config): Configuration for the S3 download.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: A list with the S3 keys that couldn&#39;t be downloaded.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Any unexpected exception raised during the download process.</span>

<span class="sd">        The function attempts to download files from S3 according to the provided configuration.</span>
<span class="sd">        It returns a list of S3 keys that couldn&#39;t be downloaded successfully.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check the access to the bucket first, or even if it does exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>

        <span class="c1"># collection_files: list of files to be downloaded</span>
        <span class="c1">#                   the list contains pair objects with the following</span>
        <span class="c1">#                   syntax: (local_path_to_be_added_to_the_local_prefix, s3_key)</span>
        <span class="c1">#                   the local_path_to_be_added_to_the_local_prefix may be none if the file doesn&#39;t exist</span>
        <span class="n">collection_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_be_downloaded</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">s3_files</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;collection_files = </span><span class="si">%s</span><span class="s2"> | bucket = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">collection_files</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
        <span class="n">failed_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">collection_file</span> <span class="ow">in</span> <span class="n">collection_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">local_prefix</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
            <span class="n">s3_file</span> <span class="o">=</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># for each file to download, create the local dir (if it does not exist)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># create the path for local file</span>
            <span class="n">local_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basename</span><span class="p">(</span><span class="n">s3_file</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_file_overwriting</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">overwrite</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># download the files</span>
            <span class="n">downloaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">keep_trying</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
                    <span class="n">dwn_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">s3_file</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> downloaded to </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> ms&quot;</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                        <span class="n">s3_file</span><span class="p">,</span>
                        <span class="n">local_file</span><span class="p">,</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">dwn_start</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">downloaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EndpointConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when downloading the file </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Exception: </span><span class="si">%s</span><span class="s2">. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">s3_file</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">,</span>
                        <span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_s3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when downloading the file </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Couldn&#39;t get the s3 client. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">s3_file</span><span class="p">,</span>
                        <span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">downloaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Could not download the file </span><span class="si">%s</span><span class="s2">. The download was </span><span class="se">\</span>
<span class="s2">retried for </span><span class="si">%s</span><span class="s2"> times. Aborting&quot;</span><span class="p">,</span>
                    <span class="n">s3_file</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s3_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">failed_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.get_secrets_from_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_secrets_from_file</span><span class="p">(</span><span class="n">secrets</span><span class="p">,</span> <span class="n">secret_file</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Read secrets from a specified file.</p>
<p>It reads the secrets from .s3cfg or aws credentials files
This function should not be used in production</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>secrets</code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary to store retrieved secrets.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>secret_file</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the file containing secrets.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>logger</code></td>
            <td>
                  <code>Logger</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger instance for error logging.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_secrets_from_file</span><span class="p">(</span><span class="n">secrets</span><span class="p">,</span> <span class="n">secret_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read secrets from a specified file.</span>

<span class="sd">    It reads the secrets from .s3cfg or aws credentials files</span>
<span class="sd">    This function should not be used in production</span>

<span class="sd">    Args:</span>
<span class="sd">        secrets (dict): Dictionary to store retrieved secrets.</span>
<span class="sd">        secret_file (str): Path to the file containing secrets.</span>
<span class="sd">        logger (Logger, optional): Logger instance for error logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dict_filled</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">secret_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">aws_credentials_file</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">aws_credentials_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;s3endpoint&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;host_bucket&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">dict_filled</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;s3endpoint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;accesskey&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;access_key&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">dict_filled</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;accesskey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;secretkey&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;secret_&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">&quot;_key&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">dict_filled</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">secrets</span><span class="p">[</span><span class="s2">&quot;secretkey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dict_filled</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">break</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.list_s3_files_obj" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_s3_files_obj</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Retrieve the content of an S3 directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>bucket</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 bucket name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>prefix</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 object key prefix.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List containing S3 object keys.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">list_s3_files_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the content of an S3 directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str): The S3 bucket name.</span>
<span class="sd">        prefix (str): The S3 object key prefix.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List containing S3 object keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">s3_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">paginator</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects_v2&quot;</span><span class="p">)</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Contents&quot;</span><span class="p">,</span> <span class="p">()):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s3_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception when trying to list files from s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listing files from s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>

    <span class="k">return</span> <span class="n">s3_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.put_files_to_s3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">put_files_to_s3</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Upload files to S3 according to the provided configuration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>config</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config" href="#rs_server_common.s3_storage_handler.s3_storage_handler.PutFilesToS3Config">PutFilesToS3Config</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for the S3 upload.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str]: A list with the local file paths that couldn't be uploaded.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>Exception</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Any unexpected exception raised during the upload process.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
      <p>The function attempts to upload files to S3 according to the provided configuration.
It returns a list of local files that couldn't be uploaded successfully.</p>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="k">def</span> <span class="nf">put_files_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PutFilesToS3Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload files to S3 according to the provided configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (PutFilesToS3Config): Configuration for the S3 upload.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: A list with the local file paths that couldn&#39;t be uploaded.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Any unexpected exception raised during the upload process.</span>

<span class="sd">        The function attempts to upload files to S3 according to the provided configuration.</span>
<span class="sd">        It returns a list of local files that couldn&#39;t be uploaded successfully.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check the access to the bucket first, or even if it does exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>

        <span class="n">collection_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_be_uploaded</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="n">failed_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">collection_file</span> <span class="ow">in</span> <span class="n">collection_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The file </span><span class="si">%s</span><span class="s2"> can&#39;t be uploaded, its s3 prefix is None&quot;</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">file_to_be_uploaded</span> <span class="o">=</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># create the s3 key</span>
            <span class="n">s3_obj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">s3_path</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_to_be_uploaded</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
            <span class="n">uploaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">keep_trying</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># get the s3 client</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Upload file </span><span class="si">%s</span><span class="s2"> to s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">file_to_be_uploaded</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                        <span class="n">s3_obj</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">file_to_be_uploaded</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">s3_obj</span><span class="p">)</span>
                    <span class="n">uploaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span>
                    <span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span><span class="p">,</span>
                    <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EndpointConnectionError</span><span class="p">,</span>
                    <span class="n">boto3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">S3UploadFailedError</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when uploading the file </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Exception: </span><span class="si">%s</span><span class="s2">. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">file_to_be_uploaded</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">,</span>
                        <span class="n">UP_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_s3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">UP_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when uploading the file </span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Couldn&#39;t get the s3 client. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">file_to_be_uploaded</span><span class="p">,</span>
                        <span class="n">UP_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">UP_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">uploaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Could not upload the file </span><span class="si">%s</span><span class="s2">. The upload was </span><span class="se">\</span>
<span class="s2">retried for </span><span class="si">%s</span><span class="s2"> times. Aborting&quot;</span><span class="p">,</span>
                    <span class="n">file_to_be_uploaded</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_to_be_uploaded</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">failed_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.s3_path_parser" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">s3_path_parser</span><span class="p">(</span><span class="n">s3_url</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Parses S3 URL to extract bucket, prefix, and file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>s3_url</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The S3 URL.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple containing bucket, prefix, and file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">s3_path_parser</span><span class="p">(</span><span class="n">s3_url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses S3 URL to extract bucket, prefix, and file.</span>

<span class="sd">    Args:</span>
<span class="sd">        s3_url (str): The S3 URL.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Tuple containing bucket, prefix, and file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s3_data</span> <span class="o">=</span> <span class="n">s3_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">s3_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">):</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_data</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s3_data</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">s3_file</span> <span class="o">=</span> <span class="n">s3_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">s3_file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.transfer_from_s3_to_s3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">transfer_from_s3_to_s3</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Copy S3 keys specified in the configuration.
Args:
    config (TransferFromS3ToS3Config): Configuration object containing bucket source, bucket destination,
              S3 files, maximum retries.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of S3 keys that failed to be copied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>Exception</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Any unexpected exception raised during the upload process.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="k">def</span> <span class="nf">transfer_from_s3_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">TransferFromS3ToS3Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy S3 keys specified in the configuration.</span>
<span class="sd">        Args:</span>
<span class="sd">            config (TransferFromS3ToS3Config): Configuration object containing bucket source, bucket destination,</span>
<span class="sd">                      S3 files, maximum retries.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of S3 keys that failed to be copied.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Any unexpected exception raised during the upload process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the access to both buckets first, or even if they do exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_bucket_access</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">)</span>

        <span class="c1"># collection_files: list of files to be downloaded</span>
        <span class="c1">#                   the list contains pair objects with the following</span>
        <span class="c1">#                   syntax: (local_path_to_be_added_to_the_local_prefix, s3_key)</span>

        <span class="n">collection_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_be_downloaded</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">s3_files</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;collection_files = </span><span class="si">%s</span><span class="s2"> | bucket = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">collection_files</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">)</span>
        <span class="n">failed_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_src</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span> <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">collection_file</span> <span class="ow">in</span> <span class="n">collection_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">copied</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">keep_trying</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;keep_trying </span><span class="si">%s</span><span class="s2"> | range(config.max_retries) </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span>
                    <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">()</span>
                    <span class="n">dwn_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">copy_src</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;copy_src = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">copy_src</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">copy_object</span><span class="p">(</span><span class="n">CopySource</span><span class="o">=</span><span class="n">copy_src</span><span class="p">,</span> <span class="n">Bucket</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> copied to s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> ms&quot;</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span>
                        <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span>
                        <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">dwn_start</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">copy_only</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">delete_file_from_s3</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Key deleted s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span> <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">copied</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EndpointConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when copying the file s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> to s3://</span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Exception: </span><span class="si">%s</span><span class="s2">. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span>
                        <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">,</span>
                        <span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_s3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;Error when copying the file s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> to s3://</span><span class="si">%s</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">Couldn&#39;t get the s3 client. Retrying in </span><span class="si">%s</span><span class="s2"> seconds for </span><span class="si">%s</span><span class="s2"> more times&quot;</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span>
                        <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span>
                        <span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="n">keep_trying</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span><span class="p">(</span><span class="n">DWN_S3FILE_RETRY_TIMEOUT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">copied</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Could not copy the file s3://</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> to s3://</span><span class="si">%s</span><span class="s2">. The copy was </span><span class="se">\</span>
<span class="s2">retried for </span><span class="si">%s</span><span class="s2"> times. Aborting&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">bucket_src</span><span class="p">,</span>
                    <span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">bucket_dst</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">failed_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="rs_server_common.s3_storage_handler.s3_storage_handler.S3StorageHandler.wait_timeout" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wait_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Wait for a specified timeout duration (minimum 200 ms).</p>
<p>This function implements a simple timeout mechanism, where it sleeps for 0.2 seconds
in each iteration until the cumulative sleep time reaches the specified timeout duration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>timeout</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total duration to wait in seconds.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">wait_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wait for a specified timeout duration (minimum 200 ms).</span>

<span class="sd">    This function implements a simple timeout mechanism, where it sleeps for 0.2 seconds</span>
<span class="sd">    in each iteration until the cumulative sleep time reaches the specified timeout duration.</span>

<span class="sd">    Args:</span>
<span class="sd">        timeout (float): The total duration to wait in seconds.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_cnt</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">while</span> <span class="n">time_cnt</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SLEEP_TIME</span><span class="p">)</span>
        <span class="n">time_cnt</span> <span class="o">+=</span> <span class="n">SLEEP_TIME</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="rs_server_common.s3_storage_handler.s3_storage_handler.TransferFromS3ToS3Config" class="doc doc-heading">
            <code>TransferFromS3ToS3Config</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>S3 configuration for copying a list with keys between buckets</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.TransferFromS3ToS3Config.s3_files">s3_files</span></code></td>
            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list with the S3 object keys to be copied.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.TransferFromS3ToS3Config.bucket_src">bucket_src</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source S3 bucket name.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.TransferFromS3ToS3Config.bucket_dst">bucket_dst</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The destination S3 bucket name.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="rs_server_common.s3_storage_handler.s3_storage_handler.TransferFromS3ToS3Config.max_retries">max_retries</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of download retries. Default is DWN_S3FILE_RETRIES.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>rs_server_common/s3_storage_handler/s3_storage_handler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TransferFromS3ToS3Config</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;S3 configuration for copying a list with keys between buckets</span>

<span class="sd">    Attributes:</span>
<span class="sd">        s3_files (list): A list with the S3 object keys to be copied.</span>
<span class="sd">        bucket_src (str): The source S3 bucket name.</span>
<span class="sd">        bucket_dst (str): The destination S3 bucket name.</span>
<span class="sd">        max_retries (int, optional): The maximum number of download retries. Default is DWN_S3FILE_RETRIES.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">s3_files</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">bucket_src</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">bucket_dst</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">copy_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DWN_S3FILE_RETRIES</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.081f42fc.min.js"></script>
      
    
  </body>
</html>